---
const { id = "member-info-modal" } = Astro.props;
---

<div id={id} class="member-info" data-lenis-prevent>
	<div class="header">
		<button class="close-btn" aria-label="關閉">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 21" fill="none">
				<path d="M19 2L2 19M2 2L19 19" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
			</svg>
		</button>
	</div>
	<h1 id="member-name"></h1>
	<h2 id="member-position"></h2>
	<div class="avatar">
		<div class="avatar-container" id="member-avatar-container">
			<!-- 根據 mode 動態生成層級 -->
		</div>
	</div>
	<p id="member-description"></p>
	<div class="social">
		<button id="member-social-btn" data-url="">Link</button>
	</div>
</div>

<script>
	const KNOWN_SITES = {
		"instagram.com": "Instagram",
		"github.com": "GitHub",
		"facebook.com": "Facebook",
		"youtube.com": "YouTube",
		"twitter.com": "Twitter",
		"x.com": "X",
		"linkedin.com": "LinkedIn",
		"plurk.com": "Plurk",
		"medium.com": "Medium"
	};

	function getSocialText(url: string) {
		try {
			const urlObj = new URL(url);
			const hostname = urlObj.hostname;
			let siteName = "";
			for (const [domain, name] of Object.entries(KNOWN_SITES)) {
				if (hostname === domain || hostname.endsWith("." + domain)) {
					siteName = name;
					break;
				}
			}
			return siteName ? `前往 ${siteName}` : `前往 ${hostname.replace(/^www\./, "")}`;
		} catch (e) {
			return `前往 ${url}`;
		}
	}

	// Unified Click Event Listener
	document.addEventListener("click", e => {
		const target = e.target as HTMLElement;

		// Open modal logic
		const trigger = target.closest(".person-trigger") as HTMLElement | null;
		if (trigger) {
			const { name, position, avatar, link, team, description, mode, color } = trigger.dataset;

			const modal = document.getElementById("member-info-modal");
			if (modal) {
				// Update Text
				const nameEl = modal.querySelector("#member-name");
				const posEl = modal.querySelector("#member-position");
				const descEl = modal.querySelector("#member-description");

				if (nameEl) nameEl.textContent = name || "";
				if (posEl) posEl.textContent = `${team} ● ${position}` || "";
				if (descEl) {
					// 將 \n 轉換成 <br> 以支援換行
					const descText = (description || "").replace(/\\n/g, "\n").replace(/\n/g, "<br>");
					descEl.innerHTML = descText;
				}

				// Update Avatar - 根據 mode 生成不同結構
				const avatarContainer = modal.querySelector("#member-avatar-container") as HTMLElement | null;
				if (avatarContainer && name) {
					const backImgUrl = `/2026/img/avatar/back/${name}.webp`;
					const frontImgUrl = `/2026/img/avatar/front/${name}.webp`;

					// 清空容器
					avatarContainer.innerHTML = "";

					if (mode === "nobg") {
						// 只有後層
						avatarContainer.innerHTML = `
							<div class="avatar-layer avatar-back">
								<img class="avatar-img" src="${backImgUrl}" alt="${name}" />
							</div>
						`;
					} else if (mode === "color") {
						// 只有前層 + 顏色背景
						avatarContainer.innerHTML = `
							<div class="avatar-layer avatar-bg" style="background-color: #${color};"></div>
							<div class="avatar-layer avatar-front">
								<img class="avatar-img" src="${frontImgUrl}" alt="${name}" />
							</div>
						`;
					} else {
						// 默認：雙層
						avatarContainer.innerHTML = `
							<div class="avatar-layer avatar-back">
								<img class="avatar-img" src="${backImgUrl}" alt="${name}" />
							</div>
							<div class="avatar-layer avatar-front">
								<img class="avatar-img" src="${frontImgUrl}" alt="${name}" />
							</div>
						`;
					}

					// 初始化 3D 效果
					init3DEffectForModal(avatarContainer);
				}

				// Update Social Button
				const socialBtn = modal.querySelector("#member-social-btn") as HTMLElement | null;
				if (socialBtn) {
					socialBtn.setAttribute("data-url", link || "");
					socialBtn.textContent = getSocialText(link || "");
					socialBtn.style.display = link ? "inline-block" : "none";
					socialBtn.setAttribute("aria-label", socialBtn.textContent || "");
				}

				modal.classList.add("show");
			}
			return;
		}

		// Close modal logic
		const closeBtn = target.closest(".member-info .close-btn");
		if (closeBtn) {
			const modal = closeBtn.closest(".member-info") as HTMLElement | null;
			if (modal) {
				modal.classList.remove("show");
			}
			return;
		}

		// Social Button Click Logic
		const socialBtn = target.closest("#member-social-btn");
		if (socialBtn) {
			const url = socialBtn.getAttribute("data-url");
			if (url) window.open(url, "_blank");
			return;
		}
	});

	// 3D 視差效果（用於 popup）- 全螢幕追蹤
	let currentModalMouseHandler: ((e: MouseEvent) => void) | null = null;

	function init3DEffectForModal(container: HTMLElement) {
		const layers = container.querySelectorAll(".avatar-layer");

		// 移除舊的全域監聽器（如果有）
		if (currentModalMouseHandler) {
			document.removeEventListener("mousemove", currentModalMouseHandler);
		}

		const handleMouseMove = (e: MouseEvent) => {
			// 計算滑鼠相對於螢幕中心的位置
			const screenCenterX = window.innerWidth / 2;
			const screenCenterY = window.innerHeight / 2;

			const mouseX = e.clientX;
			const mouseY = e.clientY;

			// 相對於螢幕中心的偏移量（標準化到 -1 到 1）
			const offsetX = (mouseX - screenCenterX) / screenCenterX;
			const offsetY = (mouseY - screenCenterY) / screenCenterY;

			layers.forEach(layer => {
				const isBack = layer.classList.contains("avatar-back");
				const isBg = layer.classList.contains("avatar-bg");

				// 後層（back）移動速度更快，製造 3D 效果
				let speedMultiplier = 1;
				if (isBack) {
					speedMultiplier = 1.8;
				} else if (isBg) {
					speedMultiplier = 0; // 背景不動
				}

				const maxOffset = 5; // 最大偏移量（像素）
				const translateX = offsetX * maxOffset * speedMultiplier;
				const translateY = offsetY * maxOffset * speedMultiplier;

				(layer as HTMLElement).style.transform = `scale(1.125) translate(${translateX}px, ${translateY}px)`;
			});
		};

		currentModalMouseHandler = handleMouseMove;

		// 全螢幕追蹤滑鼠
		document.addEventListener("mousemove", handleMouseMove);
	}

	// 關閉 modal 時清除監聽器
	function cleanup3DEffectForModal() {
		if (currentModalMouseHandler) {
			document.removeEventListener("mousemove", currentModalMouseHandler);
			currentModalMouseHandler = null;
		}
	}

	// 監聽 modal 關閉
	const modalObserver = new MutationObserver(mutations => {
		mutations.forEach(mutation => {
			if (mutation.type === "attributes" && mutation.attributeName === "class") {
				const modal = mutation.target as HTMLElement;
				if (!modal.classList.contains("show")) {
					cleanup3DEffectForModal();
				}
			}
		});
	});

	const memberModal = document.getElementById("member-info-modal");
	if (memberModal) {
		modalObserver.observe(memberModal, { attributes: true });
	}
</script>

<style>
	.member-info {
		color: black;
		background-color: white;
		width: 40rem;
		max-width: 40vw;
		height: 100vh;
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		padding: 4rem;
		box-shadow: 0 0 1rem rgba(0, 0, 0, 0.1);
		z-index: 101;
		overflow-y: auto;

		/* Animation styles */
		transform: translateX(-105%);
		transition:
			transform 0.3s ease,
			visibility 0s 0.3s;
		visibility: hidden;
	}

	.member-info.show {
		transform: translateX(0);
		visibility: visible;
		transition:
			transform 0.4s ease,
			visibility 0s 0s;
	}

	.header {
		padding-bottom: 1.5rem;
	}

	.close-btn {
		border-radius: 62rem;
		justify-content: center;
		align-items: center;
		width: 3rem;
		height: 3rem;
		position: absolute;
		top: 3rem;
		right: 3rem;
		font-size: 2rem;
		font-weight: 700;
		background-color: black;
		color: white;
		cursor: pointer;
		display: flex;
		border: none;
		transition:
			transform 0.3s ease,
			box-shadow 0.3s ease;
	}

	.close-btn:hover {
		transform: translateY(-0.25rem);
		box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
	}

	svg {
		width: 1.5rem;
		height: 1.5rem;
	}

	h1 {
		font-family: "GenKiMinTW";
		font-size: 5.25rem;
		font-weight: 700;
	}

	h2 {
		font-family: "GenKiMinTW";
		font-size: 1rem;
		font-weight: 700;
		padding: 1.5rem 0;
		line-height: 1.5;
	}

	.avatar,
	.social {
		justify-self: end;
	}

	.social {
		margin-top: 3rem;
		align-self: flex-end;
	}

	.avatar-container {
		position: relative;
		width: 10rem;
		height: 10rem;
		border-radius: 1rem;
		overflow: hidden;
	}

	.avatar-layer {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		transform: scale(1.125);
		transition: transform 0.1s ease-out;
		will-change: transform;
	}

	.avatar-bg {
		z-index: 0;
	}

	.avatar-back {
		z-index: 1;
	}

	.avatar-front {
		z-index: 2;
	}

	.avatar-img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	#member-social-btn {
		padding: 0.5rem 1rem;
		background-color: #000;
		color: #fff;
		border: none;
		border-radius: 0.3rem;
		cursor: pointer;
		font-size: 1rem;
		font-weight: 700;
		transition:
			transform 0.3s ease,
			box-shadow 0.3s ease;
	}

	#member-social-btn:hover {
		transform: translateY(-0.25rem);
		box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
	}

	p {
		width: 20rem;
		padding-top: 3.75rem;
		font-size: 1rem;
		font-weight: 700;
		line-height: 1.5;
	}

	@media (max-width: 64rem) {
		.close-btn {
			top: 2rem;
			right: 2rem;
			width: 2rem;
			height: 2rem;
			font-size: 1.5rem;
		}

		svg {
			width: 1rem;
			height: 1rem;
		}

		.member-info {
			min-width: 90vw;
			min-height: 90vh;
			max-height: 90vh;
			align-self: center;
			justify-self: center;
			position: fixed;
			padding: 2.5rem;
		}

		.header {
			padding-bottom: 2.5rem;
		}

		h1 {
			font-size: 3.5rem;
		}

		.avatar,
		.social {
			justify-self: center;
		}

		p {
			width: 100%;
		}
	}
</style>

---
const images = [
	{ src: "/2026/img/Hero/photo-wall-1.webp", alt: "SITCON 講者在舞台上進行技術演講的照片" },
	{ src: "/2026/img/Hero/photo-wall-2.webp", alt: "SITCON 進行夏令營在大教室的照片" },
	{ src: "/2026/img/Hero/photo-wall-3.webp", alt: "SITCON 在中央研究院中，最大的會議廳進行講座的照片" },
	{ src: "/2026/img/Hero/photo-wall-4.webp", alt: "SITCON 講者在舞台上進行技術演講的照片" },
	{ src: "/2026/img/Hero/photo-wall-5.webp", alt: "SITCON 場外交流區，參與者彼此聊天與交換心得的照片" }
];
---

<section class="photo-wall">
	<div class="photo-container">
		{
			images.map((img, index) => (
				<div class={`photo-item item-${index}`}>
					<div class="img-wrapper">
						<img src={img.src} alt={img.alt} />{" "}
					</div>
				</div>
			))
		}
	</div>
</section>

<style>
	.photo-wall {
		width: 100%;
		padding: 0 0 400px;
		margin: 3rem 0;
		display: flex;
		justify-content: flex-start;
		overflow: hidden;
	}

	.photo-container {
		display: flex;
		gap: 24px;
		width: max-content;
		align-items: flex-start;
		will-change: transform;
	}

	.photo-item {
		flex: 0 0 350px;
		aspect-ratio: 3 / 4;
		position: relative;
	}

	.img-wrapper {
		width: 100%;
		height: 100%;
		background-color: #ccc; /* 遵守規範：佔位符 */
		box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
		overflow: hidden;
	}

	.photo-item img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	/* 階梯式排列 (左上到右下) */
	.item-0 {
		transform: translateY(0);
	}
	.item-1 {
		transform: translateY(80px);
	}
	.item-2 {
		transform: translateY(160px);
	}
	.item-3 {
		transform: translateY(240px);
	}
	.item-4 {
		transform: translateY(320px);
	}

	@media (max-width: 768px) {
		.photo-wall {
			padding: 40px 0 150px;
		}
		.photo-container {
			display: flex;
			gap: 16px;
			width: max-content;
			padding: 0;
			justify-content: flex-start;
		}
		.photo-item {
			flex: 0 0 180px;
			aspect-ratio: 3 / 4;
		}
		/* 窄版維持階梯式排列，但間距縮小 */
		.item-0 {
			transform: translateY(0);
		}
		.item-1 {
			transform: translateY(20px);
		}
		.item-2 {
			transform: translateY(40px);
		}
		.item-3 {
			transform: translateY(60px);
		}
		.item-4 {
			transform: translateY(80px);
		}
	}
</style>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";

	gsap.registerPlugin(ScrollTrigger);

	const prefersReducedMotion = () => window.matchMedia("(prefers-reduced-motion: reduce)").matches;

	const initPhotoWall = () => {
		const container = document.querySelector(".photo-container") as HTMLElement | null;
		const photoWall = document.querySelector(".photo-wall") as HTMLElement | null;
		if (!container || !photoWall) return () => {};
		if (photoWall.dataset.photoInit === "true") return () => {};
		photoWall.dataset.photoInit = "true";

		if (prefersReducedMotion()) {
			return () => {
				photoWall.dataset.photoInit = "false";
			};
		}

		let animation: gsap.core.Tween | null = null;
		let resizeTimeout: ReturnType<typeof setTimeout> | null = null;

		const createAnimation = () => {
			// 清除舊的動畫
			if (animation) {
				animation.kill();
			}

			const offset = Math.min(window.innerWidth, 1440) * 0.2;
			animation = gsap.fromTo(
				container,
				{ x: offset },
				{
					x: -(container.scrollWidth - photoWall.clientWidth + offset),
					ease: "none",
					scrollTrigger: {
						trigger: photoWall,
						start: "top bottom",
						end: "bottom top",
						scrub: 0.3,
						invalidateOnRefresh: true
					}
				}
			);
		};

		createAnimation();

		const onResize = () => {
			if (resizeTimeout) clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(() => {
				ScrollTrigger.refresh();
				createAnimation();
			}, 200);
		};

		window.addEventListener("resize", onResize);

		return () => {
			if (resizeTimeout) clearTimeout(resizeTimeout);
			window.removeEventListener("resize", onResize);
			if (animation) {
				animation.scrollTrigger?.kill();
				animation.kill();
			}
			photoWall.dataset.photoInit = "false";
		};
	};

	let cleanup: (() => void) | null = null;
	const mount = () => {
		cleanup?.();
		cleanup = initPhotoWall();
	};

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", mount, { once: true });
	} else {
		mount();
	}

	const pageLoadHandler = () => mount();
	const beforeSwapHandler = () => {
		cleanup?.();
		document.removeEventListener("astro:page-load", pageLoadHandler);
		document.removeEventListener("astro:before-swap", beforeSwapHandler);
	};

	document.addEventListener("astro:page-load", pageLoadHandler);
	document.addEventListener("astro:before-swap", beforeSwapHandler);
</script>

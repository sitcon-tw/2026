---
import { Plane, Users, CodeXml } from "@lucide/astro";

const tickets = [
	{
		id: "oscvpass",
		title: "開源貢獻票",
		englishTitle: "OSCVPASS",
		color: "#e6d3a3",
		icon: CodeXml,
		serial: "#877855A",
		description: [
			"資格限制：對開源專案有貢獻者。",
			"在 2025/01/21 23:59 前申請且通過者，有機會可以搶到 SITCON 2025 開源貢獻票邀請碼。",
			"關於歷年來 OSCVPass 申請通過者的專案列表，請參考 OSCVPass 專案介紹。"
		],
		verticalTitle: "開源貢獻票"
	},
	{
		id: "general",
		title: "一般票",
		englishTitle: "GENERAL",
		color: "#e0e0e0",
		icon: Users,
		serial: "#GNR2026",
		description: ["一般大眾皆可參與。", "請關注 SITCON 官方網站及社群媒體以獲取最新售票資訊。", "憑 QR Code 入場。"],
		verticalTitle: "一般票"
	},
	{
		id: "long-distance",
		title: "遠道而來票",
		englishTitle: "DISTANCE",
		color: "#c5a880",
		icon: Plane,
		serial: "#LNG2026",
		description: ["居住地距離會場較遠的參與者。", "需提供相關證明文件。", "補助部分交通或住宿。"],
		verticalTitle: "遠道而來票"
	}
];

const danmakuLines = [
	"竟然完全免費？",
	"SITCON 自己的報名系統？",
	"立即申請",
	"千萬不要錯過！！！",
	"真的假的啦也太佛？？？",
	"免費還不衝？？",
	"手速慢一點就沒了吧",
	"報名入口在哪！！",
	"這波是官方認證的香",
	"這不是詐騙吧（是認真的）",
	"我只問一句：還能再更爽嗎",
	"想去 +1",
	"我要去蹭 knowledge",
	"我要去吸收能量",
	"想聽神仙 talk",
	"我只想當個快樂聽眾",
	"SITCON 2026 Let's GO",
	"工程師的熱情",
	"開源精神",
	"學生最大的年會"
];
---

<section>
	<div class="container">
		<div class="title">
			<h1>索票方式</h1>
		</div>

		<div class="ticket-container">
			{
				tickets.map((ticket, index) => (
					<div class={`ticket-card ${index === 0 ? "active" : ""}`} data-index={index} style={`--bg-color: ${ticket.color};`}>
						<div class="ticket-mobile-header">
							<span class="mobile-title">{ticket.title}</span>
							<div class="mobile-toggle">+</div>
						</div>

						<div class="ticket-body">
							<div class="ticket-main">
								<div class="ticket-main-inner">
									<div class="ticket-top-info">
										<div class="ticket-event-title">SITCON 2026</div>
										<div class="ticket-serial">{ticket.serial}</div>
									</div>

									<div class="ticket-header">
										<h2 class="ticket-title">{ticket.englishTitle}</h2>
									</div>

									<ul class="ticket-desc">
										{ticket.description.map(item => (
											<li>{item}</li>
										))}
									</ul>

									<div class="ticket-actions">
										<button class="btn-outline">立即索票</button>
										<button class="btn-outline">加入行事曆</button>
									</div>
								</div>
							</div>

							<div class="ticket-divider">
								<div class="dashed-line" />
							</div>

							<div class="ticket-stub">
								<div class="ticket-vertical-text">{ticket.verticalTitle}</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
	</div>

	<div class="danmaku-container" id="danmaku-container" data-lines={JSON.stringify(danmakuLines)}></div>
</section>

<style>
	section {
		position: relative;
		width: 100%;
		min-height: 50rem;
		overflow: hidden;
		padding-bottom: 4rem;
	}

	.container {
		position: relative;
		z-index: 10;
		display: flex;
		flex-direction: column;
		align-items: center;
		height: 100%;
		padding: 0 1.5rem;
	}

	.title {
		font-size: 2.25rem;
		padding-top: 6rem;
		color: white;
		text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
		margin-bottom: 3rem;
	}

	.title h1 {
		font-weight: 700;
	}

	.ticket-container {
		display: flex;
		flex-direction: row;
		width: 100%;
		max-width: 80rem;
		height: 30rem;
		gap: 1.5rem;
	}

	.ticket-card {
		position: relative;
		height: 100%;
		background-color: var(--bg-color);
		border-radius: 1.5rem;
		overflow: hidden;
		cursor: pointer;
		flex: 1;
		min-width: 6rem;
		transition: flex 0.6s cubic-bezier(0.25, 1, 0.5, 1);
		box-shadow: 0 0.625rem 1.875rem rgba(0, 0, 0, 0.15);

		--stub-width: 6rem;
		--notch-size: 1.5rem;
		--notch-radius: calc(var(--notch-size) / 2);
		--notch-center: calc(100% - var(--stub-width));

		-webkit-mask-image:
			radial-gradient(circle at var(--notch-center) 0, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius)),
			radial-gradient(circle at var(--notch-center) 100%, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius));
		mask-image:
			radial-gradient(circle at var(--notch-center) 0, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius)),
			radial-gradient(circle at var(--notch-center) 100%, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius));

		-webkit-mask-composite: source-in;
		mask-composite: intersect;
	}

	.ticket-card.active {
		flex: 10;
		cursor: default;
		box-shadow: 0 1.25rem 3.125rem rgba(0, 0, 0, 0.3);
	}

	.ticket-card:hover:not(.active) {
		flex: 1.5;
	}

	.ticket-body {
		display: flex;
		flex-direction: row;
		width: 100%;
		height: 100%;
		white-space: nowrap;
	}

	.ticket-main {
		flex: 1;
		min-width: 0;
		height: 100%;
		overflow: hidden;
		position: relative;
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.ticket-card.active .ticket-main {
		opacity: 1;
		transition-delay: 0.2s;
	}

	.ticket-main-inner {
		width: 40rem;
		padding: 3rem;
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	.ticket-top-info {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		position: absolute;
		top: 2.5rem;
		right: 2rem;
		text-align: right;
	}

	.ticket-event-title {
		font-weight: 700;
		color: #333;
		opacity: 0.6;
		letter-spacing: 0.05em;
		font-size: 1rem;
	}

	.ticket-serial {
		font-family: monospace;
		font-weight: 700;
		color: #333;
		opacity: 0.4;
		font-size: 0.875rem;
		letter-spacing: 0.05em;
		margin-top: 0.25rem;
		border: 0.0625rem solid rgba(51, 51, 51, 0.2);
		padding: 0.1rem 0.5rem;
		border-radius: 1rem;
	}

	.ticket-header {
		margin-bottom: 2rem;
		margin-top: 1rem;
	}

	.ticket-title {
		font-size: 4.5rem;
		font-weight: 800;
		color: #333;
		line-height: 1;
		text-transform: uppercase;
	}

	.ticket-desc {
		list-style: none;
		padding: 0;
		margin: 0;
		flex: 1;
		white-space: normal;
	}

	.ticket-desc li {
		font-size: 1.1rem;
		color: #333;
		margin-bottom: 0.75rem;
		padding-left: 1rem;
		position: relative;
		font-weight: 600;
		line-height: 1.6;
	}

	.ticket-desc li::before {
		content: "•";
		position: absolute;
		left: 0;
		font-weight: bold;
	}

	.ticket-actions {
		display: flex;
		gap: 1rem;
		margin-top: 2rem;
	}

	.btn-outline {
		background: transparent;
		color: #333;
		border: 0.125rem solid #333;
		padding: 0.75rem 2rem;
		font-size: 1.125rem;
		font-weight: 700;
		border-radius: 50rem;
		cursor: pointer;
		white-space: nowrap;
		transition: all 0.2s ease;
	}

	.btn-outline:hover {
		background: #333;
		color: var(--bg-color);
	}

	.ticket-divider {
		width: 0.0625rem;
		height: 85%;
		align-self: center;
		position: relative;
		flex-shrink: 0;
	}

	.dashed-line {
		width: 100%;
		height: 100%;
		border-left: 0.125rem dashed rgba(51, 51, 51, 0.3);
	}

	.ticket-stub {
		width: 6rem;
		min-width: 6rem;
		height: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 2.5rem 0;
		flex-shrink: 0;
	}

	.ticket-vertical-text {
		writing-mode: vertical-rl;
		font-size: 2.25rem;
		font-weight: 900;
		letter-spacing: 0.3em;
		color: #333;
		white-space: nowrap;
		flex: 1;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ticket-mobile-header {
		display: none;
	}

	.danmaku-container {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		pointer-events: none;
		z-index: 1;
		user-select: none;
		overflow: hidden;
	}

	:global(.danmaku-item) {
		position: absolute;
		white-space: nowrap;
		font-weight: 900;
		color: white;
		opacity: 0.12;
		will-change: transform;
	}

	@media (max-width: 56.25rem) {
		.ticket-container {
			flex-direction: column;
			height: auto;
			gap: 1rem;
		}

		.ticket-card {
			flex: none;
			width: 100%;
			height: auto;
			min-width: 0;
			max-height: 4.5rem;
			transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
			mask-image: none;
			-webkit-mask-image: none;
		}

		.ticket-card.active {
			flex: none;
			max-height: 50rem;
		}

		.ticket-mobile-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 1.5rem;
			height: 4.5rem;
			background: rgba(0, 0, 0, 0.05);
			width: 100%;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 20;
		}

		.mobile-title {
			font-size: 1.5rem;
			font-weight: 900;
			color: #333;
		}

		.mobile-toggle {
			font-size: 2rem;
			font-weight: 300;
			color: #333;
			transition: transform 0.3s;
		}

		.ticket-card.active .mobile-toggle {
			transform: rotate(45deg);
		}

		.ticket-divider,
		.ticket-stub {
			display: none;
		}

		.ticket-body {
			flex-direction: column;
			height: auto;
			white-space: normal;
			margin-top: 4.5rem;
		}

		.ticket-main {
			padding: 1.5rem;
			opacity: 1;
			width: 100%;
		}

		.ticket-main-inner {
			width: 100%;
			padding: 0;
		}

		.ticket-top-info {
			display: none;
		}

		.ticket-title {
			font-size: 2.5rem;
		}

		.ticket-actions {
			flex-direction: column;
			width: 100%;
		}

		.btn-outline {
			width: 100%;
			justify-content: center;
		}
	}
</style>

<script>
	import { gsap } from "gsap";

	class DanmakuSystem {
		private container: HTMLElement;
		private lines: string[];
		private rows: number = 6;
		private fontSize: number = 0;
		private speed: number = 150;
		private gap: number = 80;
		private rowState: { lastEndTime: number }[] = [];
		private animationFrameId: number = 0;
		private startTime: number = 0;

		constructor(container: HTMLElement, lines: string[]) {
			this.container = container;
			this.lines = lines;
			this.init();
		}

		private init() {
			this.updateFontSize();
			this.rowState = Array.from({ length: this.rows }, () => ({ lastEndTime: 0 }));
			this.start();
			window.addEventListener("resize", this.handleResize.bind(this));
		}

		private updateFontSize() {
			const screenWidth = window.innerWidth;
			this.fontSize = Math.max(48, Math.min(80, screenWidth * 0.06));
		}

		private measureText(text: string): number {
			const canvas = document.createElement("canvas");
			const ctx = canvas.getContext("2d");
			if (!ctx) return text.length * this.fontSize;
			ctx.font = `900 ${this.fontSize}px sans-serif`;
			return ctx.measureText(text).width;
		}

		private getRandomText(): string {
			return this.lines[Math.floor(Math.random() * this.lines.length)];
		}

		private createDanmaku(row: number, initialOffset: number = 0) {
			const text = this.getRandomText();
			const textWidth = this.measureText(text);
			const screenWidth = window.innerWidth;
			const totalDistance = screenWidth + textWidth;
			const duration = totalDistance / this.speed;

			const el = document.createElement("p");
			el.className = "danmaku-item";
			el.textContent = text;
			el.style.fontSize = `${this.fontSize}px`;
			el.style.top = `${(row / this.rows) * 100}%`;
			el.style.left = `${screenWidth + initialOffset}px`;

			this.container.appendChild(el);

			const timeUntilFullyEntered = (textWidth + this.gap) / this.speed;
			this.rowState[row].lastEndTime = performance.now() + timeUntilFullyEntered * 1000;

			gsap.to(el, {
				x: -totalDistance,
				duration: duration,
				ease: "none",
				onComplete: () => {
					el.remove();
				}
			});
		}

		private tick = (currentTime: number) => {
			for (let row = 0; row < this.rows; row++) {
				if (currentTime >= this.rowState[row].lastEndTime) {
					this.createDanmaku(row);
				}
			}
			this.animationFrameId = requestAnimationFrame(this.tick);
		};

		private start() {
			this.container.innerHTML = "";
			this.startTime = performance.now();
			for (let row = 0; row < this.rows; row++) {
				const initialDelay = (row * 0.3 + Math.random() * 0.5) * 1000;
				this.rowState[row].lastEndTime = this.startTime + initialDelay;
			}
			this.animationFrameId = requestAnimationFrame(this.tick);
		}

		private handleResize() {
			cancelAnimationFrame(this.animationFrameId);
			gsap.killTweensOf(".danmaku-item");
			this.container.innerHTML = "";
			this.updateFontSize();
			this.start();
		}

		destroy() {
			cancelAnimationFrame(this.animationFrameId);
			gsap.killTweensOf(".danmaku-item");
			window.removeEventListener("resize", this.handleResize.bind(this));
		}
	}

	const danmakuContainer = document.getElementById("danmaku-container");
	if (danmakuContainer) {
		const linesData = danmakuContainer.dataset.lines;
		if (linesData) {
			new DanmakuSystem(danmakuContainer, JSON.parse(linesData));
		}
	}

	const cards = document.querySelectorAll(".ticket-card");

	cards.forEach(card => {
		card.addEventListener("click", function () {
			const isMobile = window.innerWidth <= 900;

			if (isMobile && this.classList.contains("active")) {
				this.classList.remove("active");
			} else {
				cards.forEach(t => t.classList.remove("active"));
				this.classList.add("active");
			}
		});
	});
</script>

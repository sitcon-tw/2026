---
import { Plane, Users, CodeXml } from "@lucide/astro";

const tickets = [
	{
		id: "oscvpass",
		title: "開源貢獻票",
		englishTitle: "OSCVPASS",
		color: "#e6d3a3",
		pill: "#e6d3a3",
		icon: CodeXml,
		description: [
			"資格限制：對開源專案有貢獻者。",
			"在 2025/01/21 23:59 前申請且通過者，有機會可以搶到 SITCON 2025 開源貢獻票邀請碼。申請表單、申請資格及更詳細的申請說明，請參考開源貢獻者快速通關",
			"關於歷年來 OSCVPass 申請通過者的專案列表，請參考 OSCVPass 專案介紹。"
		],
		verticalTitle: "開源貢獻票"
	},
	{
		id: "general",
		title: "一般票",
		englishTitle: "GENERAL",
		color: "#e0e0e0",
		pill: "#E0E0E0",
		icon: Users,
		description: ["一般大眾皆可參與。", "請關注 SITCON 官方網站及社群媒體以獲取最新售票資訊。"],
		verticalTitle: "一般票"
	},
	{
		id: "long-distance",
		title: "遠道而來票",
		englishTitle: "LONG DISTANCE",
		color: "#c5a880",
		pill: "#c5a880",
		icon: Plane,
		description: ["居住地距離會場較遠的參與者。", "需提供相關證明文件。"],
		verticalTitle: "遠道而來票"
	}
];

const danmakuLines = ["竟然完全免費？", "所以我可以怎麼來？？？", "SITCON 自己的報名系統？", "崴崴孟孟 一起去日本", "立即申請", "SITCON{AloGuys_By_OsGa}", "千萬不要錯過！！！"];
---

<section>
	<div class="container">
		<div class="title">
			<h1>索票方式</h1>
		</div>
		<div class="ticket-container">
			{
				tickets.map((ticket, index) => (
					<div class={`ticket-card ${index === 0 ? "active" : ""}`} data-id={ticket.id} style={`--bg-color: ${ticket.color}; --index: ${index};`}>
						<div class="ticket-mobile-header">
							<span class="mobile-title">{ticket.title}</span>
							<ticket.icon class="mobile-icon" />
						</div>
						<div class="ticket-content">
							<div class="ticket-main">
								<div class="ticket-header">
									<h2 class="ticket-title">{ticket.englishTitle}</h2>
									<span class="ticket-sitcon">SITCON 2026</span>
								</div>
								<ul class="ticket-desc">
									{ticket.description.map(item => (
										<li>{item}</li>
									))}
								</ul>
								<div class="ticket-actions">
									<button class="btn-primary">立即索票</button>
									<button class="btn-secondary">加入行事曆</button>
								</div>
							</div>
							<div class="ticket-divider" />
							<div class="ticket-side">
								<div class="ticket-stub-inner">
									<div class="ticket-pill">{ticket.pill}</div>
									<div class="ticket-vertical-text">{ticket.verticalTitle}</div>
									<div class="ticket-info">
										<div class="ticket-info-corner">
											<div class="ticket-date">2026/03/28</div>
											<div class="ticket-location">中央研究院 人文社會科學館</div>
										</div>
										<div class="ticket-sitcon-small">SITCON 2026</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
	</div>

	<!-- 彈幕容器，由 JS 動態生成內容 -->
	<div class="danmaku-container" id="danmaku-container" data-lines={JSON.stringify(danmakuLines)}></div>
</section>

<style>
	section {
		position: relative;
		width: 100%;
		height: 56rem;
		overflow: hidden;
	}

	.container {
		position: relative;
		z-index: 10;
		display: flex;
		flex-direction: column;
		align-items: center;
		height: 100%;
	}

	.title {
		font-size: 2.25rem;
		padding-top: 6rem;
		color: white;
		text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
	}

	.title h1 {
		font-weight: 700;
	}

	.ticket-container {
		position: relative;
		width: 67rem;
		height: 30rem;
		margin-top: 2rem;
		perspective: 62.5rem;
	}

	.ticket-mobile-header {
		display: none;
		padding: 1.5rem 2rem;
		justify-content: space-between;
		align-items: center;
		border-bottom: 0.125rem dashed rgba(0, 0, 0, 0.1);
	}

	.mobile-title {
		font-size: 2.5rem;
		font-weight: 900;
		color: #333;
	}

	.mobile-icon {
		width: 2.5rem;
		height: 2.5rem;
		color: #333;
	}

	.ticket-card {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: var(--bg-color);
		border-radius: 1.25rem;
		box-shadow: -0.3125rem 0 1.25rem rgba(0, 0, 0, 0.15);
		cursor: pointer;
		overflow: hidden;
		transform-origin: right center;
		mask-image: radial-gradient(circle at calc(100% - 12rem) 0, transparent 0.9375rem, black 1rem), radial-gradient(circle at calc(100% - 12rem) 100%, transparent 0.9375rem, black 1rem);
		-webkit-mask-image: radial-gradient(circle at calc(100% - 12rem) 0, transparent 0.9375rem, black 1rem), radial-gradient(circle at calc(100% - 12rem) 100%, transparent 0.9375rem, black 1rem);
		mask-composite: intersect;
		-webkit-mask-composite: source-in;
		will-change: transform, height;
	}

	.ticket-card.active {
		cursor: default;
	}

	.ticket-content {
		display: flex;
		height: 100%;
		width: 100%;
	}

	.ticket-main {
		flex: 1;
		padding: 3rem;
		display: flex;
		flex-direction: column;
	}

	.ticket-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 1.5rem;
	}

	.ticket-title {
		font-size: 5rem;
		font-weight: 900;
		color: #333;
		line-height: 1;
	}

	.ticket-sitcon {
		font-size: 1.25rem;
		font-weight: 700;
		color: #333;
	}

	.ticket-desc {
		list-style: none;
		padding: 0;
		color: #444;
		font-size: 1.1rem;
		line-height: 1.6;
		flex: 1;
	}

	.ticket-desc li {
		margin-bottom: 0.75rem;
		position: relative;
		padding-left: 1.25rem;
	}

	.ticket-desc li::before {
		content: "•";
		position: absolute;
		left: 0;
		font-weight: bold;
	}

	.ticket-actions {
		display: flex;
		gap: 1.5rem;
		margin-top: 1rem;
	}

	.btn-primary,
	.btn-secondary {
		padding: 0.75rem 2.5rem;
		border-radius: 62.4375rem;
		font-size: 1.5rem;
		font-weight: 700;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.btn-primary {
		background: transparent;
		border: 0.125rem solid #333;
		color: #333;
	}

	.btn-primary:hover {
		background: #333;
		color: white;
	}

	.btn-secondary {
		background: transparent;
		border: 0.125rem solid rgba(0, 0, 0, 0.3);
		color: #333;
	}

	.btn-secondary:hover {
		border-color: #333;
	}

	.ticket-divider {
		width: 0;
		border-left: 0.125rem dashed rgba(0, 0, 0, 0.2);
		margin: 2rem 0;
	}

	.ticket-side {
		width: 12rem;
		height: 100%;
		position: relative;
		overflow: hidden;
	}

	.ticket-stub-inner {
		position: absolute;
		top: 0;
		left: 12rem;
		width: 30rem;
		height: 12rem;
		transform: rotate(90deg);
		transform-origin: 0 0;
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		align-items: flex-start;
		padding: 1.5rem 2rem;
	}

	.ticket-pill {
		background: rgba(0, 0, 0, 0.05);
		border: 0.0625rem solid rgba(0, 0, 0, 0.1);
		padding: 0.2rem 0.8rem;
		border-radius: 62.4375rem;
		font-size: 0.875rem;
		font-family: monospace;
		color: #333;
		white-space: nowrap;
		align-self: flex-end;
		margin-bottom: 0.5rem;
		z-index: 2;
		text-transform: uppercase;
	}

	.ticket-vertical-text {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		font-size: 3.5rem;
		font-weight: 900;
		color: #333;
		letter-spacing: 0.5rem;
		white-space: nowrap;
		z-index: 1;
	}

	.ticket-info {
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		align-items: flex-end;
		height: 100%;
		font-size: 0.75rem;
		color: #333;
		z-index: 2;
	}

	.ticket-info-corner {
		order: 2;
		text-align: right;
		display: flex;
		flex-direction: column;
		gap: 0.2rem;
		align-items: flex-end;
		font-weight: 700;
	}

	.ticket-sitcon-small {
		order: 1;
		font-weight: 700;
		margin-top: 0.25rem;
	}

	.danmaku-container {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		pointer-events: none;
		z-index: 1;
		user-select: none;
		overflow: hidden;
	}

	/* 彈幕樣式，font-size 由 JS 動態設定 */
	:global(.danmaku-item) {
		position: absolute;
		left: 100%;
		white-space: nowrap;
		font-weight: 900;
		color: white;
		opacity: 0.12;
		animation-name: fly;
		animation-timing-function: linear;
		animation-iteration-count: infinite;
		will-change: transform;
	}

	@media (max-width: 768px) {
		section {
			height: auto;
			padding-bottom: 4rem;
		}

		.container {
			padding: 0 1.5rem;
		}

		.ticket-container {
			width: 100%;
			height: 50rem;
			margin-top: 3rem;
		}

		.ticket-mobile-header {
			display: flex;
		}

		.ticket-card {
			transform-origin: center top;
			mask-image: radial-gradient(circle at 0 calc(100% - 8rem), transparent 0.9375rem, black 1rem), radial-gradient(circle at 100% calc(100% - 8rem), transparent 0.9375rem, black 1rem);
			-webkit-mask-image: radial-gradient(circle at 0 calc(100% - 8rem), transparent 0.9375rem, black 1rem), radial-gradient(circle at 100% calc(100% - 8rem), transparent 0.9375rem, black 1rem);
			box-shadow: 0 -0.3125rem 0.9375rem rgba(0, 0, 0, 0.1);
		}

		.ticket-content {
			flex-direction: column;
			height: calc(100% - 5rem);
			overflow: hidden;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.ticket-card.active .ticket-content {
			opacity: 1;
		}

		.ticket-main {
			padding: 1.5rem;
			overflow-y: auto;
		}

		.ticket-title {
			font-size: 2.5rem;
		}

		.ticket-desc {
			font-size: 1rem;
		}

		.btn-primary,
		.btn-secondary {
			padding: 0.5rem 1.5rem;
			font-size: 1.1rem;
		}

		.ticket-divider {
			width: 100%;
			height: 0;
			border-left: none;
			border-top: 0.125rem dashed rgba(0, 0, 0, 0.1);
			margin: 0;
		}

		.ticket-side {
			display: none;
		}

		.ticket-stub-inner {
			position: static;
			width: 100%;
			height: auto;
			transform: none;
			display: flex;
			flex-direction: row;
			justify-content: space-between;
			align-items: center;
			padding: 0;
		}

		.ticket-pill {
			margin-bottom: 0;
		}

		.ticket-info {
			height: auto;
			opacity: 1;
			text-align: right;
		}

		.ticket-info-corner {
			display: block;
		}
	}

	@keyframes fly {
		from {
			transform: translateX(0);
		}
		to {
			transform: translateX(calc(-100vw - 100%));
		}
	}
</style>

<script>
	import { gsap } from "gsap";

	// ==================== 彈幕動態生成 ====================
	const ROWS = 8;
	const ITEMS_PER_ROW = 6;
	const FIXED_DURATION = 35;
	const SAFETY_GAP_SEC = 2;

	// 用 Canvas 測量實際文字寬度
	function measureTextWidth(text: string, fontSize: number): number {
		const canvas = document.createElement("canvas");
		const ctx = canvas.getContext("2d");
		if (!ctx) return text.length * fontSize;
		ctx.font = `900 ${fontSize}px sans-serif`;
		return ctx.measureText(text).width;
	}

	// 計算彈幕間距時間
	function calculateDelay(text: string, fontSize: number, screenWidth: number): number {
		const textWidth = measureTextWidth(text, fontSize);
		const totalDistance = screenWidth + textWidth;
		const speed = totalDistance / FIXED_DURATION;
		const timeForText = textWidth / speed;
		return timeForText + SAFETY_GAP_SEC;
	}

	// 生成彈幕
	function generateDanmaku() {
		const container = document.getElementById("danmaku-container");
		if (!container) return;

		const linesData = container.dataset.lines;
		if (!linesData) return;
		const lines: string[] = JSON.parse(linesData);

		container.innerHTML = "";

		const screenWidth = window.innerWidth;
		const fontSize = Math.max(48, Math.min(80, screenWidth * 0.06));

		for (let r = 0; r < ROWS; r++) {
			let currentDelay = -(r * 1.5) - Math.random() * 5;

			for (let i = 0; i < ITEMS_PER_ROW; i++) {
				const text = lines[Math.floor(Math.random() * lines.length)];
				const top = (r / ROWS) * 85;

				const p = document.createElement("p");
				p.className = "danmaku-item";
				p.textContent = text;
				p.style.cssText = `
					top: ${top}%;
					font-size: ${fontSize}px;
					animation-duration: ${FIXED_DURATION}s;
					animation-delay: ${currentDelay.toFixed(2)}s;
				`;

				container.appendChild(p);
				currentDelay += calculateDelay(text, fontSize, screenWidth);
			}
		}
	}

	// 初始化彈幕
	generateDanmaku();

	// 視窗大小改變時重新生成
	let resizeTimeout: number;
	window.addEventListener("resize", () => {
		clearTimeout(resizeTimeout);
		resizeTimeout = window.setTimeout(() => {
			generateDanmaku();
		}, 300);
	});

	// ==================== 票卡互動邏輯 ====================
	const cards = document.querySelectorAll(".ticket-card");
	const ticketContainer = document.querySelector(".ticket-container");
	const sideWidth = 12 * 16;
	const mobileHeaderHeight = 5 * 16;
	const overlap = 3.125 * 16;
	let currentActiveIndex = 0;

	function updateCards(activeIndex: number) {
		if (!ticketContainer) return;
		currentActiveIndex = activeIndex;
		const isMobile = window.innerWidth <= 768;
		const containerWidth = ticketContainer.getBoundingClientRect().width;
		const containerHeight = ticketContainer.getBoundingClientRect().height;

		if (isMobile) {
			let inactiveCount = 0;
			cards.forEach((card, index) => {
				const htmlCard = card as HTMLElement;
				if (index === activeIndex) {
					gsap.set(htmlCard, { zIndex: cards.length + 1 });
					gsap.to(htmlCard, {
						x: 0,
						y: (cards.length - 1) * mobileHeaderHeight,
						height: containerHeight - (cards.length - 1) * mobileHeaderHeight,
						duration: 0.7,
						ease: "expo.out",
						force3D: true,
						overwrite: "auto",
						onComplete: () => {
							gsap.set(htmlCard, { zIndex: cards.length });
						}
					});
					htmlCard.classList.add("active");
				} else {
					const targetY = inactiveCount * mobileHeaderHeight;
					gsap.to(htmlCard, {
						x: 0,
						y: targetY,
						zIndex: inactiveCount + 1,
						height: mobileHeaderHeight,
						duration: 0.7,
						ease: "expo.out",
						force3D: true,
						overwrite: "auto"
					});
					htmlCard.classList.remove("active");
					inactiveCount++;
				}
			});
		} else {
			cards.forEach((card, index) => {
				const htmlCard = card as HTMLElement;
				gsap.set(htmlCard, { height: "100%" });
				if (index === activeIndex) {
					gsap.set(htmlCard, { zIndex: cards.length + 1 });
					gsap.to(htmlCard, {
						x: 0,
						y: 0,
						rotationY: 0,
						scale: 1,
						duration: 0.7,
						ease: "expo.out",
						force3D: true,
						overwrite: "auto",
						onComplete: () => {
							gsap.set(htmlCard, { zIndex: cards.length });
						}
					});
					htmlCard.classList.add("active");
				} else if (index > activeIndex) {
					const offset = (index - activeIndex - 1) * overlap;
					const targetX = containerWidth - sideWidth + offset;
					gsap.to(htmlCard, {
						x: targetX,
						y: 0,
						zIndex: cards.length - index,
						rotationY: -10,
						scale: 0.95,
						duration: 0.7,
						ease: "expo.out",
						force3D: true,
						overwrite: "auto"
					});
					htmlCard.classList.remove("active");
				} else {
					gsap.to(htmlCard, {
						x: -containerWidth,
						y: 0,
						zIndex: index,
						rotationY: 10,
						duration: 0.7,
						ease: "expo.out",
						force3D: true,
						overwrite: "auto"
					});
					htmlCard.classList.remove("active");
				}
			});
		}
	}

	cards.forEach((card, index) => {
		card.addEventListener("click", () => {
			updateCards(index);
		});

		card.addEventListener("mouseenter", () => {
			const isMobile = window.innerWidth <= 768;
			if (!isMobile && index > currentActiveIndex) {
				gsap.to(card, {
					x: "-=30",
					duration: 0.3,
					ease: "power2.out"
				});
			}
		});

		card.addEventListener("mouseleave", () => {
			const isMobile = window.innerWidth <= 768;
			if (!isMobile && index > currentActiveIndex) {
				updateCards(currentActiveIndex);
			}
		});
	});

	window.addEventListener("resize", () => {
		updateCards(currentActiveIndex);
	});

	updateCards(0);
</script>

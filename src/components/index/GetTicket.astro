---
import { Plane, Users, CodeXml } from "@lucide/astro";
import Danmaku from "./effects/Danmaku.astro";
import danmakuData from "../../data/danmakuLines.json";
import { useTranslations, type Lang } from "@/utils/i18n";

interface Props {
	lang?: Lang;
}

const lang = Astro.props.lang ?? "zh";
const i18n = useTranslations(lang);
const t = i18n.ticket;

const tickets = [
	{
		id: "student",
		title: t.student.title,
		englishTitle: t.student.englishTitle,
		color: "#D8C08A",
		icon: CodeXml,
		description: t.student.description,
		verticalTitle: t.student.verticalTitle
	},
	{
		id: "oscvpass",
		title: t.oscvpass.title,
		englishTitle: t.oscvpass.englishTitle,
		color: "#e6d3a3",
		icon: CodeXml,
		description: t.oscvpass.description,
		verticalTitle: t.oscvpass.verticalTitle
	},
	{
		id: "general",
		title: t.general.title,
		englishTitle: t.general.englishTitle,
		color: "#e0e0e0",
		icon: Users,
		description: t.general.description,
		verticalTitle: t.general.verticalTitle
	},
	{
		id: "long-distance",
		title: t.longDistance.title,
		englishTitle: t.longDistance.englishTitle,
		color: "#c5a880",
		icon: Plane,
		description: t.longDistance.description,
		verticalTitle: t.longDistance.verticalTitle
	}
];

const danmakuLines: string[] = danmakuData.lines;
---

<section id="get-ticket">
	<div class="container">
		<div class="title">
			<h1 class="text-reveal-title">{t.title}</h1>
		</div>

		<div class="ticket-container">
			{
				tickets.map((ticket, index) => (
					<div class={`ticket-card ${index === 0 ? "active" : ""}`} data-index={index} data-lang={lang} style={`--bg-color: ${ticket.color};`}>
						<button class="ticket-mobile-header" type="button" aria-expanded={index === 0 ? "true" : "false"}>
							<span class="mobile-title">{ticket.title}</span>
							<span class="mobile-toggle" aria-hidden="true">
								+
							</span>
						</button>

						<div class="ticket-content-wrapper">
							<div class="ticket-body">
								<div class="ticket-main">
									<div class="ticket-main-inner">
										<div class="ticket-top-row">
											<div class="ticket-header">
												<div class="icon-circle">
													<ticket.icon size={28} />
												</div>
												<div class="title-wrapper">
													<h2 class="ticket-title" data-max-size="64">
														{ticket.englishTitle}
													</h2>
												</div>
											</div>

											<div class="ticket-main-sitcon">SITCON 2026</div>
										</div>

										<ul class="ticket-desc">
											{ticket.description.map(item => (
												<li>
													<span set:html={item} />
												</li>
											))}
										</ul>

										<div class="ticket-actions">
											<div class="action-buttons">
												<button class="btn-outline">{t.buttons.getTicket}</button>
												<button class="btn-outline">{t.buttons.addCalendar}</button>
											</div>

											<div class="ticket-bottom-meta">
												<span class="meta-text meta-date">{i18n.landing.date}</span>
												<div class="barcode" />
												<span class="meta-text meta-location">{t.location}</span>
											</div>
										</div>
									</div>
								</div>

								<div class="ticket-stub">
									<div class="ticket-vertical-text-wrapper">
										<div class="ticket-vertical-text" data-max-size="28">
											{ticket.verticalTitle}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
	</div>

	<Danmaku lines={danmakuLines} />
</section>

<style>
	section {
		position: relative;
		width: 100%;
		min-height: 50rem;
		overflow: hidden;
		padding-bottom: 4rem;
		background-color: #ac782b;
	}

	.container {
		position: relative;
		z-index: 10;
		display: flex;
		flex-direction: column;
		align-items: center;
		height: 100%;
		padding: 0 1.5rem;
	}

	.title {
		font-size: 2.25rem;
		padding-top: 6rem;
		color: white;
		text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
		margin-bottom: 3rem;
	}

	.title h1 {
		font-weight: 700;
	}

	.ticket-container {
		display: flex;
		flex-direction: row;
		width: 100%;
		max-width: 80rem;
		height: 30rem;
		gap: 1.5rem;
	}

	.ticket-card {
		position: relative;
		height: 100%;
		background-color: var(--bg-color);
		border-radius: 1.5rem;
		overflow: hidden;
		cursor: pointer;
		flex: 1;
		min-width: 6rem;
		transition: flex 0.6s cubic-bezier(0.25, 1, 0.5, 1);
		box-shadow: 0 0.625rem 1.875rem rgba(0, 0, 0, 0.15);

		--stub-width: 7rem;
		--notch-size: 1.5rem;
		--notch-radius: calc(var(--notch-size) / 2);
		--notch-center: calc(100% - var(--stub-width));

		-webkit-mask-image:
			radial-gradient(circle at var(--notch-center) 0, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius)),
			radial-gradient(circle at var(--notch-center) 100%, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius));
		mask-image:
			radial-gradient(circle at var(--notch-center) 0, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius)),
			radial-gradient(circle at var(--notch-center) 100%, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius));

		-webkit-mask-composite: source-in;
		mask-composite: intersect;
	}

	.ticket-card.active {
		flex: 10;
		cursor: default;
		box-shadow: 0 1.25rem 3.125rem rgba(0, 0, 0, 0.3);
	}

	.ticket-card:hover:not(.active) {
		flex: 1.5;
	}

	.ticket-content-wrapper {
		height: 100%;
	}

	.ticket-body {
		display: flex;
		flex-direction: row;
		width: 100%;
		height: 100%;
		white-space: nowrap;
	}

	.ticket-main {
		flex: 1;
		min-width: 0;
		height: 100%;
		overflow: hidden;
		position: relative;
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.ticket-card.active .ticket-main {
		opacity: 1;
		transition-delay: 0.2s;
	}

	.ticket-main-inner {
		width: 50rem;
		padding: 3rem;
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	.ticket-top-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
		width: 100%;
		gap: 1.5rem;
	}

	.ticket-header {
		display: flex;
		align-items: center;
		gap: 1rem;
		flex: 1;
		min-width: 0;
		overflow: hidden;
	}

	.title-wrapper {
		flex: 1;
		min-width: 0;
		overflow: hidden;
	}

	.ticket-main-sitcon {
		font-size: 1rem;
		font-weight: 900;
		color: #333;
		letter-spacing: 0.1em;
		flex-shrink: 0;
	}

	.icon-circle {
		width: 3.5rem;
		height: 3.5rem;
		background: rgba(0, 0, 0, 0.08);
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #333;
		flex-shrink: 0;
	}

	.ticket-title {
		font-size: 4rem;
		font-weight: 800;
		color: #333;
		line-height: 1.1;
		text-transform: uppercase;
		white-space: nowrap;
		margin: 0;
		display: inline-block;
	}

	.ticket-desc {
		list-style: none;
		padding: 0;
		margin: 0;
		flex: 1;
		white-space: normal;
	}

	.ticket-desc li {
		font-size: 1.1rem;
		color: #333;
		margin-bottom: 0.75rem;
		padding-left: 1rem;
		position: relative;
		font-weight: 600;
		line-height: 1.6;
	}

	.ticket-card[data-lang="en"] .ticket-desc li {
		font-size: 0.85rem;
		line-height: 1.5;
	}

	.ticket-desc li::before {
		content: "â€¢";
		position: absolute;
		left: 0;
		font-weight: bold;
	}

	.ticket-desc :global(a) {
		color: #5c3611;
		text-decoration: underline;
		text-underline-offset: 0.2em;
		font-weight: 700;
		transition: opacity 0.2s;
	}

	.ticket-desc :global(a:hover) {
		opacity: 0.7;
	}

	.ticket-actions {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		margin-top: 2rem;
		border-top: 0.125rem dashed rgba(0, 0, 0, 0.1);
		padding-top: 2rem;
		gap: 1.5rem;
	}

	.action-buttons {
		display: flex;
		gap: 1rem;
	}

	.ticket-bottom-meta {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 0.25rem;
		flex-shrink: 0;
	}

	.meta-text {
		font-size: 0.85rem;
		font-weight: 700;
		color: #333;
		opacity: 0.7;
		letter-spacing: 0.02em;
		white-space: nowrap;
	}

	.btn-outline {
		background: transparent;
		color: #333;
		border: 0.125rem solid #333;
		padding: 0.75rem 2rem;
		font-size: 1.125rem;
		font-weight: 700;
		border-radius: 50rem;
		cursor: pointer;
		white-space: nowrap;
		transition: all 0.2s ease;
	}

	.btn-outline:hover {
		background: #333;
		color: var(--bg-color);
	}

	.barcode {
		width: 10rem;
		height: 2.25rem;
		background-image: repeating-linear-gradient(90deg, transparent, transparent 0.125rem, #333 0.125rem, #333 0.25rem, transparent 0.25rem, transparent 0.3125rem, #333 0.3125rem, #333 0.5rem);
		opacity: 0.5;
		margin: 0.25rem 0;
	}

	.ticket-stub {
		width: var(--stub-width);
		min-width: var(--stub-width);
		height: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 2rem 0;
		flex-shrink: 0;
		border-left: 0.125rem dashed rgba(0, 0, 0, 0.15);
		background-color: rgba(255, 255, 255, 0.05);
		position: relative;
		overflow: hidden;
	}

	.ticket-vertical-text-wrapper {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		overflow: hidden;
	}

	.ticket-vertical-text {
		writing-mode: horizontal-tb;
		transform: rotate(90deg);
		font-size: 1.75rem;
		font-weight: 900;
		letter-spacing: 0.15em;
		color: #333;
		white-space: nowrap;
		opacity: 0.85;
		text-align: center;
		display: inline-block;
	}

	.ticket-mobile-header {
		display: none;
	}

	@media (max-width: 80rem) {
		.ticket-container {
			max-width: 64rem;
			height: 28rem;
		}

		.ticket-main-inner {
			width: 36rem;
			padding: 2.5rem;
		}

		.ticket-title {
			font-size: 3.25rem;
		}

		.ticket-main-sitcon {
			font-size: 1.25rem;
		}

		.ticket-desc li {
			font-size: 1rem;
		}

		.btn-outline {
			padding: 0.625rem 1.5rem;
			font-size: 1rem;
		}
	}

	@media (max-width: 64rem) {
		.title {
			font-size: 2rem;
			padding-top: 5rem;
			margin-bottom: 2.5rem;
		}

		.ticket-container {
			height: 26rem;
			gap: 1rem;
		}

		.ticket-card {
			--stub-width: 5.5rem;
			min-width: 5.5rem;
		}

		.ticket-main-inner {
			width: 32rem;
			padding: 2rem;
		}

		.ticket-top-row {
			flex-direction: column;
			gap: 1rem;
			align-items: flex-start;
			margin-bottom: 1.5rem;
		}

		.ticket-header {
			margin-bottom: 0;
			width: 100%;
			margin-right: 0;
		}

		.icon-circle {
			width: 3rem;
			height: 3rem;
		}

		.ticket-title {
			font-size: 2.75rem;
		}

		.ticket-desc li {
			font-size: 0.95rem;
			margin-bottom: 0.5rem;
		}

		.ticket-actions {
			margin-top: 1.5rem;
			padding-top: 1.5rem;
			flex-wrap: wrap;
			gap: 1rem;
		}

		.action-buttons {
			gap: 0.75rem;
		}

		.ticket-bottom-meta {
			align-items: flex-end;
		}

		.btn-outline {
			padding: 0.5rem 1.25rem;
			font-size: 0.9rem;
		}

		.barcode {
			width: 8rem;
			height: 2rem;
		}

		.ticket-vertical-text {
			font-size: 1.5rem;
		}
	}

	@media (max-width: 48rem) {
		section {
			min-height: auto;
			padding-bottom: 3rem;
		}

		.container {
			padding: 0 1rem;
		}

		.title {
			font-size: 1.75rem;
			padding-top: 4rem;
			margin-bottom: 2rem;
		}

		.ticket-container {
			flex-direction: column;
			height: auto;
			gap: 0.75rem;
		}

		.ticket-card {
			flex: none !important;
			width: 100%;
			height: auto;
			min-width: 0;
			border-radius: 1rem;
			cursor: default;
			box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.1);
			mask-image: none;
			-webkit-mask-image: none;
			overflow: hidden;
		}

		.ticket-card.active {
			box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.2);
		}

		.ticket-card:hover:not(.active) {
			flex: none !important;
		}

		.ticket-mobile-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 1.25rem;
			height: 4rem;
			background: rgba(0, 0, 0, 0.05);
			width: 100%;
			cursor: pointer;
			border: none;
			font-family: inherit;
		}

		.mobile-title {
			font-size: 1.25rem;
			font-weight: 800;
			color: #333;
		}

		.mobile-toggle {
			font-size: 1.75rem;
			font-weight: 300;
			color: #333;
			transition: transform 0.3s ease;
			width: 2rem;
			height: 2rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.ticket-card.active .mobile-toggle {
			transform: rotate(45deg);
		}

		.ticket-stub {
			display: none;
		}

		.ticket-content-wrapper {
			max-height: 0;
			overflow: hidden;
			transition: max-height 0.4s ease-out;
		}

		.ticket-card.active .ticket-content-wrapper {
			max-height: 40rem;
		}

		.ticket-body {
			flex-direction: column;
			height: auto;
			white-space: normal;
		}

		.ticket-main {
			padding: 0;
			opacity: 1;
			width: 100%;
			height: auto;
			overflow: visible;
			transition: none;
		}

		.ticket-card.active .ticket-main {
			transition-delay: 0s;
		}

		.ticket-main-inner {
			width: 100%;
			padding: 1.25rem;
			padding-top: 0.75rem;
			height: auto;
		}

		.ticket-header {
			margin-bottom: 0;
		}

		.ticket-top-row {
			flex-direction: row;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.ticket-main-sitcon {
			display: none;
		}

		.icon-circle {
			width: 2.5rem;
			height: 2.5rem;
		}

		.ticket-title {
			font-size: 1.75rem;
		}

		.ticket-desc {
			margin-bottom: 1rem;
		}

		.ticket-desc li {
			font-size: 0.9rem;
			margin-bottom: 0.5rem;
			line-height: 1.5;
			padding-left: 0.875rem;
		}

		.ticket-actions {
			flex-direction: column-reverse;
			gap: 1rem;
			align-items: stretch;
			margin-top: 1rem;
			padding-top: 1rem;
		}

		.action-buttons {
			flex-direction: column;
			width: 100%;
			gap: 0.625rem;
		}

		.ticket-bottom-meta {
			flex-direction: column;
			align-items: center;
			gap: 0.5rem;
			width: 100%;
		}

		.meta-text {
			font-size: 0.85rem;
		}

		.btn-outline {
			width: 100%;
			justify-content: center;
			padding: 0.75rem 1.5rem;
			font-size: 1rem;
			text-align: center;
		}

		.barcode {
			width: 100%;
			height: 2rem;
			opacity: 0.25;
		}
	}

	@media (max-width: 23.4375rem) {
		.container {
			padding: 0 0.75rem;
		}

		.title {
			font-size: 1.5rem;
			padding-top: 3rem;
			margin-bottom: 1.5rem;
		}

		.ticket-mobile-header {
			padding: 0 1rem;
			height: 3.5rem;
		}

		.mobile-title {
			font-size: 1.1rem;
		}

		.ticket-main-inner {
			padding: 1rem;
			padding-top: 0.5rem;
		}

		.icon-circle {
			width: 2.25rem;
			height: 2.25rem;
		}

		.ticket-title {
			font-size: 1.5rem;
		}

		.ticket-desc li {
			font-size: 0.85rem;
			margin-bottom: 0.375rem;
		}

		.btn-outline {
			padding: 0.625rem 1rem;
			font-size: 0.9rem;
		}
	}
</style>

<script>
	function initTicketCards() {
		const cards = document.querySelectorAll<HTMLElement>(".ticket-card");
		const MOBILE_BREAKPOINT = 768;

		function isMobile(): boolean {
			return window.innerWidth <= MOBILE_BREAKPOINT;
		}

		function updateAriaExpanded(card: HTMLElement, expanded: boolean) {
			const header = card.querySelector(".ticket-mobile-header");
			if (header) {
				header.setAttribute("aria-expanded", String(expanded));
			}
		}

		function handleMobileClick(card: HTMLElement) {
			if (card.classList.contains("active")) {
				card.classList.remove("active");
				updateAriaExpanded(card, false);
			} else {
				cards.forEach(c => {
					c.classList.remove("active");
					updateAriaExpanded(c, false);
				});
				card.classList.add("active");
				updateAriaExpanded(card, true);

				setTimeout(() => {
					card.scrollIntoView({ behavior: "smooth", block: "nearest" });
				}, 150);
			}
		}

		function handleDesktopClick(card: HTMLElement) {
			if (!card.classList.contains("active")) {
				cards.forEach(t => t.classList.remove("active"));
				card.classList.add("active");
			}
		}

		function fitText(el: HTMLElement) {
			const wrapper = el.parentElement;
			if (!wrapper) return;

			const maxSize = parseInt(el.dataset.maxSize || "64");
			let fontSize = maxSize;
			el.style.fontSize = `${fontSize}px`;

			const isVertical = el.classList.contains("ticket-vertical-text");

			if (isVertical) {
				const containerHeight = wrapper.clientHeight || 400;
				while (el.scrollWidth > containerHeight && fontSize > 12) {
					fontSize -= 1;
					el.style.fontSize = `${fontSize}px`;
				}
			} else {
				const containerWidth = wrapper.clientWidth;
				if (containerWidth === 0) return;

				while (el.scrollWidth > containerWidth && fontSize > 14) {
					fontSize -= 1;
					el.style.fontSize = `${fontSize}px`;
				}
			}
		}

		function adjustAllFonts() {
			const titles = document.querySelectorAll<HTMLElement>(".ticket-title");
			const verticalTitles = document.querySelectorAll<HTMLElement>(".ticket-vertical-text");

			titles.forEach(fitText);
			verticalTitles.forEach(fitText);
		}

		cards.forEach(card => {
			const mobileHeader = card.querySelector<HTMLElement>(".ticket-mobile-header");
			if (mobileHeader) {
				mobileHeader.addEventListener("click", e => {
					if (isMobile()) {
						e.preventDefault();
						e.stopPropagation();
						handleMobileClick(card);
					}
				});
			}

			card.addEventListener("click", e => {
				const target = e.target as HTMLElement;

				if (isMobile()) {
					return;
				}

				if (target.closest(".action-buttons")) {
					return;
				}

				handleDesktopClick(card);
			});
		});

		let lastIsMobile = isMobile();

		function handleResize() {
			const currentIsMobile = isMobile();
			adjustAllFonts();

			if (lastIsMobile !== currentIsMobile) {
				cards.forEach((card, index) => {
					if (index === 0) {
						card.classList.add("active");
						updateAriaExpanded(card, true);
					} else {
						card.classList.remove("active");
						updateAriaExpanded(card, false);
					}
				});
				lastIsMobile = currentIsMobile;
			}
		}

		window.addEventListener("resize", handleResize);

		const observer = new ResizeObserver(() => {
			requestAnimationFrame(adjustAllFonts);
		});

		cards.forEach(card => observer.observe(card));

		requestAnimationFrame(adjustAllFonts);
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initTicketCards);
	} else {
		initTicketCards();
	}
</script>

---
import { Plane, Users, CodeXml } from "@lucide/astro";
import Danmaku from "./effects/Danmaku.astro";
import danmakuData from "../../data/danmakuLines.json";
import { useTranslations, type Lang } from "@/utils/i18n";

interface Props {
	lang?: Lang;
}

const lang = Astro.props.lang ?? "zh";
const i18n = useTranslations(lang);
const t = i18n.ticket;

const tickets = [
	{
		id: "student",
		title: t.student.title,
		englishTitle: t.student.englishTitle,
		color: "#D8C08A",
		icon: CodeXml,
		description: t.student.description,
		verticalTitle: t.student.verticalTitle
	},
	{
		id: "general",
		title: t.general.title,
		englishTitle: t.general.englishTitle,
		color: "#e0e0e0",
		icon: Users,
		description: t.general.description,
		verticalTitle: t.general.verticalTitle
	},
	{
		id: "oscvpass",
		title: t.oscvpass.title,
		englishTitle: t.oscvpass.englishTitle,
		color: "#e6d3a3",
		icon: CodeXml,
		description: t.oscvpass.description,
		verticalTitle: t.oscvpass.verticalTitle
	},
	{
		id: "long-distance",
		title: t.longDistance.title,
		englishTitle: t.longDistance.englishTitle,
		color: "#c5a880",
		icon: Plane,
		description: t.longDistance.description,
		verticalTitle: t.longDistance.verticalTitle
	}
];

const danmakuLines: string[] = danmakuData.lines;
---

<section id="get-ticket">
	<div class="container">
		<div class="title">
			<h1 class="text-reveal-title">{t.title}</h1>
		</div>

		<div class="ticket-container">
			{
				tickets.map((ticket, index) => (
					<div class={`ticket-card ${index === 0 ? "active" : ""}`} data-index={index} data-lang={lang} style={`--bg-color: ${ticket.color};`}>
						<button class="ticket-mobile-header" type="button" aria-expanded={index === 0 ? "true" : "false"}>
							<span class="mobile-title">{ticket.title}</span>
							<span class="mobile-toggle" aria-hidden="true">
								+
							</span>
						</button>

						<div class="ticket-content-wrapper">
							<div class="ticket-body">
								<div class="ticket-main">
									<div class="ticket-main-inner">
										<div class="ticket-top-row">
											<div class="ticket-header">
												<div class="icon-circle">
													<ticket.icon size={28} />
												</div>
												<div class="title-wrapper">
													<h2 class="ticket-title" data-max-size="4">
														{ticket.englishTitle}
													</h2>
												</div>
											</div>

											<div class="ticket-main-sitcon">SITCON 2026</div>
										</div>

										<ul class="ticket-desc">
											{ticket.description.map(item => (
												<li>
													<span set:html={item} />
												</li>
											))}
										</ul>

										<div class="ticket-actions">
											<div class="action-buttons">
												<a class="btn-outline" href="https://sitcon.org/tickets" target="_blank" rel="noopener noreferrer">
													{t.buttons.getTicket}
												</a>
												<a class="btn-outline" href="/2026/SITCON_2026_重要時程.ics" download>
													{t.buttons.addCalendar}
												</a>
											</div>

											<div class="ticket-bottom-meta">
												<span class="meta-text meta-date">{i18n.landing.date}</span>
												<div class="barcode" />
												<span class="meta-text meta-location">{t.location}</span>
											</div>
										</div>
									</div>
								</div>

								<div class="ticket-stub">
									<div class="ticket-vertical-text-wrapper">
										<div class="ticket-vertical-text" data-max-size="1.75">
											{ticket.verticalTitle}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
		<div class="referral-container">
			<div>
				<h2 class="referral-title">{i18n.ticket.referral.title}</h2>
				<p class="referral-description" set:html={i18n.ticket.referral.description1} />
				<p class="referral-description" set:html={i18n.ticket.referral.description2} />
				<p class="referral-description bold" set:html={i18n.ticket.referral.description3} />
			</div>
			<div class="referral-content">
				<a class="btn-filled" href="referral">
					<svg xmlns="http://www.w3.org/2000/svg" width="49" height="49" viewBox="0 0 49 49" fill="none" aria-hidden="true">
						<path d="M3.5 24.5H45.5M45.5 24.5L24.5 3.5M45.5 24.5L24.5 45.5" stroke="#634A15" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"></path>
					</svg>
				</a>
			</div>
		</div>
	</div>

	<Danmaku lines={danmakuLines} />
</section>

<style>
	section {
		position: relative;
		width: 100%;
		overflow: hidden;
		padding-bottom: 4rem;
		background-color: #ac782b;
	}

	.container {
		position: relative;
		z-index: 10;
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 0 1.5rem;
	}

	.referral-container {
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		height: 100%;
		gap: 3rem;
		padding: 4rem 6rem;
	}

	.referral-title {
		font-size: 2.25rem;
		font-weight: 700;
		color: white;
		text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
		margin-bottom: 1.5rem;
	}

	.referral-content {
		display: flex;
		align-items: flex-end;
	}

	.referral-description {
		font-size: 1.125rem;
		font-weight: 400;
		color: white;
		text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
		margin-bottom: 1.5rem;
	}

	.referral-description.bold {
		font-weight: 700;
	}

	.title {
		font-size: 2.25rem;
		padding-top: 6rem;
		color: white;
		text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
		margin-bottom: 3rem;
	}

	.title h1 {
		font-weight: 700;
	}

	.ticket-container {
		display: flex;
		flex-direction: row;
		width: 100%;
		max-width: 80rem;
		aspect-ratio: 2.5 / 1;
		min-height: 20rem;
		gap: 1.5rem;
	}

	.ticket-card {
		position: relative;
		height: 100%;
		background-color: var(--bg-color);
		border-radius: 1.5rem;
		overflow: hidden;
		cursor: pointer;
		flex: 1;
		min-width: 6rem;
		transition: flex 0.6s cubic-bezier(0.25, 1, 0.5, 1);
		box-shadow: 0 0.625rem 1.875rem rgba(0, 0, 0, 0.15);

		--stub-width: 7rem;
		--notch-size: 1.5rem;
		--notch-radius: calc(var(--notch-size) / 2);
		--notch-center: calc(100% - var(--stub-width));

		-webkit-mask-image:
			radial-gradient(circle at var(--notch-center) 0, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius)),
			radial-gradient(circle at var(--notch-center) 100%, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius));
		mask-image:
			radial-gradient(circle at var(--notch-center) 0, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius)),
			radial-gradient(circle at var(--notch-center) 100%, transparent calc(var(--notch-radius) - 0.03125rem), black var(--notch-radius));

		-webkit-mask-composite: source-in;
		mask-composite: intersect;
	}

	.ticket-card.active {
		flex: 10;
		cursor: default;
		box-shadow: 0 1.25rem 3.125rem rgba(0, 0, 0, 0.3);
	}

	.ticket-card:hover:not(.active) {
		flex: 1.5;
	}

	.ticket-content-wrapper {
		height: 100%;
	}

	.ticket-body {
		display: flex;
		flex-direction: row;
		width: 100%;
		height: 100%;
		white-space: nowrap;
	}

	.ticket-main {
		flex: 1;
		min-width: 0;
		height: 100%;
		overflow: hidden;
		position: relative;
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.ticket-card.active .ticket-main {
		opacity: 1;
		transition-delay: 0.2s;
	}

	.ticket-main-inner {
		width: 100%;
		max-width: 50rem;
		padding: 3rem;
		display: flex;
		flex-direction: column;
		height: 100%;
		box-sizing: border-box;
	}

	.ticket-top-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
		width: 100%;
		gap: 1.5rem;
		flex-wrap: wrap;
		flex-shrink: 0;
	}

	.ticket-header {
		display: flex;
		align-items: center;
		gap: 1rem;
		flex: 1;
		min-width: 0;
		overflow: hidden;
	}

	.title-wrapper {
		flex: 1;
		min-width: 0;
		overflow: hidden;
	}

	.ticket-main-sitcon {
		font-size: 1rem;
		font-weight: 900;
		color: #333;
		letter-spacing: 0.1em;
		flex-shrink: 0;
	}

	.icon-circle {
		width: 3.5rem;
		height: 3.5rem;
		background: rgba(0, 0, 0, 0.08);
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #333;
		flex-shrink: 0;
	}

	.ticket-title {
		font-size: 4rem;
		font-weight: 800;
		color: #333;
		line-height: 1.1;
		text-transform: uppercase;
		white-space: nowrap;
		margin: 0;
		display: inline-block;
	}

	.ticket-desc {
		list-style: none;
		padding: 0;
		margin: 0;
		flex: 1;
		white-space: normal;
		overflow-y: auto;
		min-height: 0;
	}

	.ticket-desc li {
		font-size: 1.1rem;
		color: #333;
		margin-bottom: 0.75rem;
		padding-left: 1rem;
		position: relative;
		font-weight: 600;
		line-height: 1.6;
	}

	.ticket-card[data-lang="en"] .ticket-desc li {
		font-size: 0.85rem;
		line-height: 1.5;
	}

	.ticket-desc li::before {
		content: "•";
		position: absolute;
		left: 0;
		font-weight: bold;
	}

	.ticket-desc :global(a) {
		color: #5c3611;
		text-decoration: underline;
		text-underline-offset: 0.2em;
		font-weight: 700;
		transition: opacity 0.2s;
	}

	.ticket-desc :global(a:hover) {
		opacity: 0.7;
	}

	.ticket-actions {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		margin-top: auto;
		border-top: 0.125rem dashed rgba(0, 0, 0, 0.1);
		padding-top: 1.5rem;
		gap: 1.5rem;
		flex-wrap: wrap;
		flex-shrink: 0;
	}

	.action-buttons {
		display: flex;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.ticket-bottom-meta {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 0.25rem;
		flex-shrink: 0;
	}

	.meta-text {
		font-size: 0.85rem;
		font-weight: 700;
		color: #333;
		opacity: 0.7;
		letter-spacing: 0.02em;
		white-space: nowrap;
	}

	.btn-outline {
		display: inline-block;
		text-decoration: none;
		background: transparent;
		color: #333;
		border: 0.125rem solid #333;
		padding: 0.75rem 2rem;
		font-size: 1.125rem;
		font-weight: 700;
		border-radius: 50rem;
		cursor: pointer;
		white-space: nowrap;
		transition: all 0.2s ease;
	}

	.btn-outline:hover {
		background: #333;
		color: var(--bg-color);
	}

	.btn-filled {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 6rem;
		height: 6rem;
		background-color: #ffd172;
		border-radius: 50%;
		transition:
			transform 0.3s ease,
			background-color 0.3s ease;
		flex-shrink: 0;
	}

	.btn-filled:hover {
		transform: scale(1.125);
		background-color: #fff;
	}

	.barcode {
		width: 10rem;
		height: 2.25rem;
		background-image: repeating-linear-gradient(90deg, transparent, transparent 0.125rem, #333 0.125rem, #333 0.25rem, transparent 0.25rem, transparent 0.3125rem, #333 0.3125rem, #333 0.5rem);
		opacity: 0.5;
		margin: 0.25rem 0;
	}

	.ticket-stub {
		width: var(--stub-width);
		min-width: var(--stub-width);
		height: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 2rem 0;
		flex-shrink: 0;
		border-left: 0.125rem dashed rgba(0, 0, 0, 0.15);
		background-color: rgba(255, 255, 255, 0.05);
		position: relative;
		overflow: hidden;
	}

	.ticket-vertical-text-wrapper {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		overflow: hidden;
	}

	.ticket-vertical-text {
		writing-mode: horizontal-tb;
		transform: rotate(90deg);
		font-size: 1.75rem;
		font-weight: 900;
		letter-spacing: 0.15em;
		color: #333;
		white-space: nowrap;
		opacity: 0.85;
		text-align: center;
		display: inline-block;
	}

	.ticket-mobile-header {
		display: none;
	}

	/* ===== 大螢幕 (80rem 以下) ===== */
	@media (max-width: 80rem) {
		.ticket-container {
			max-width: 64rem;
			aspect-ratio: 2.25 / 1;
		}

		.ticket-main-inner {
			max-width: 36rem;
			padding: 2.5rem;
		}

		.ticket-title {
			font-size: 3.25rem;
		}

		.ticket-main-sitcon {
			font-size: 1.25rem;
		}

		.ticket-desc li {
			font-size: 1rem;
		}

		.btn-outline {
			padding: 0.625rem 1.5rem;
			font-size: 1rem;
		}
	}

	/* ===== 中等螢幕 (64rem 以下) ===== */
	@media (max-width: 64rem) {
		.referral-container {
			flex-direction: column;
			align-items: flex-end;
			gap: 2rem;
			padding: 4rem 2rem 0;
		}

		.title {
			font-size: 2rem;
			padding-top: 5rem;
			margin-bottom: 2.5rem;
		}

		.ticket-container {
			aspect-ratio: 2 / 1;
			gap: 1rem;
		}

		.ticket-card {
			--stub-width: 5.5rem;
			min-width: 5.5rem;
		}

		.ticket-main-inner {
			max-width: 32rem;
			padding: 2rem;
		}

		.ticket-top-row {
			flex-direction: column;
			gap: 1rem;
			align-items: flex-start;
			margin-bottom: 1.5rem;
		}

		.ticket-header {
			margin-bottom: 0;
			width: 100%;
			margin-right: 0;
		}

		.icon-circle {
			width: 3rem;
			height: 3rem;
		}

		.ticket-title {
			font-size: 2.75rem;
		}

		.ticket-desc li {
			font-size: 0.95rem;
			margin-bottom: 0.5rem;
		}

		.ticket-actions {
			padding-top: 1rem;
			gap: 1rem;
		}

		.action-buttons {
			gap: 0.75rem;
		}

		.ticket-bottom-meta {
			align-items: flex-end;
		}

		.btn-outline {
			padding: 0.5rem 1.25rem;
			font-size: 0.9rem;
		}

		.barcode {
			width: 8rem;
		}

		.ticket-vertical-text {
			font-size: 1.5rem;
		}
	}

	/* ===== 中間斷點 (56rem 以下) ===== */
	@media (max-width: 56rem) {
		.ticket-container {
			aspect-ratio: 1.75 / 1;
			gap: 0.75rem;
		}

		.ticket-card {
			--stub-width: 4.5rem;
			min-width: 4.5rem;
		}

		.ticket-main-inner {
			max-width: 28rem;
			padding: 1.75rem;
		}

		.ticket-title {
			font-size: 2.25rem;
		}

		.ticket-desc li {
			font-size: 0.9rem;
			margin-bottom: 0.4rem;
			line-height: 1.5;
		}

		.ticket-actions {
			flex-direction: column;
			align-items: flex-start;
			gap: 1rem;
		}

		.action-buttons {
			width: 100%;
		}

		.ticket-bottom-meta {
			width: 100%;
			flex-direction: row;
			justify-content: space-between;
			align-items: center;
		}

		.barcode {
			width: 6rem;
		}

		.btn-outline {
			padding: 0.5rem 1rem;
			font-size: 0.85rem;
		}

		.ticket-vertical-text {
			font-size: 1.25rem;
		}
	}

	/* ===== 平板/手機過渡 (48rem 以下) ===== */
	@media (max-width: 48rem) {
		section {
			padding-bottom: 3rem;
		}

		.container {
			padding: 0 1rem;
		}

		.title {
			font-size: 1.75rem;
			padding-top: 4rem;
			margin-bottom: 2rem;
		}

		.ticket-container {
			flex-direction: column;
			aspect-ratio: unset;
			height: auto;
			min-height: unset;
			gap: 0.75rem;
		}

		.ticket-card {
			flex: none !important;
			width: 100%;
			height: auto;
			min-width: 0;
			border-radius: 1rem;
			cursor: default;
			box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.1);
			mask-image: none;
			-webkit-mask-image: none;
			overflow: hidden;
		}

		.ticket-card.active {
			box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.2);
		}

		.ticket-card:hover:not(.active) {
			flex: none !important;
		}

		.ticket-mobile-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 1rem 1.25rem;
			background: rgba(0, 0, 0, 0.05);
			width: 100%;
			cursor: pointer;
			border: none;
			font-family: inherit;
		}

		.mobile-title {
			font-size: 1.25rem;
			font-weight: 800;
			color: #333;
		}

		.mobile-toggle {
			font-size: 1.75rem;
			font-weight: 300;
			color: #333;
			transition: transform 0.3s ease;
			line-height: 1;
		}

		.ticket-card.active .mobile-toggle {
			transform: rotate(45deg);
		}

		.ticket-stub {
			display: none;
		}

		.ticket-content-wrapper {
			display: grid;
			grid-template-rows: 0fr;
			transition: grid-template-rows 0.4s ease-out;
		}

		.ticket-card.active .ticket-content-wrapper {
			grid-template-rows: 1fr;
		}

		.ticket-body {
			flex-direction: column;
			height: auto;
			white-space: normal;
			overflow: hidden;
		}

		.ticket-main {
			padding: 0;
			opacity: 1;
			width: 100%;
			height: auto;
			overflow: visible;
			transition: none;
		}

		.ticket-card.active .ticket-main {
			transition-delay: 0s;
		}

		.ticket-main-inner {
			width: 100%;
			max-width: none;
			padding: 1.25rem;
			padding-top: 0.75rem;
			height: auto;
		}

		.ticket-header {
			margin-bottom: 0;
		}

		.ticket-top-row {
			flex-direction: row;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.ticket-main-sitcon {
			display: none;
		}

		.icon-circle {
			width: 2.5rem;
			height: 2.5rem;
		}

		.ticket-title {
			font-size: 1.75rem;
		}

		.ticket-desc {
			margin-bottom: 1rem;
			overflow-y: visible;
		}

		.ticket-desc li {
			font-size: 0.9rem;
			margin-bottom: 0.5rem;
			line-height: 1.5;
			padding-left: 0.875rem;
		}

		.ticket-actions {
			flex-direction: column-reverse;
			gap: 1rem;
			align-items: stretch;
			margin-top: 1rem;
			padding-top: 1rem;
		}

		.action-buttons {
			flex-direction: column;
			width: 100%;
			gap: 0.625rem;
		}

		.ticket-bottom-meta {
			flex-direction: column;
			align-items: center;
			gap: 0.5rem;
			width: 100%;
		}

		.meta-text {
			font-size: 0.85rem;
		}

		.btn-outline {
			width: 100%;
			justify-content: center;
			padding: 0.75rem 1.5rem;
			font-size: 1rem;
			text-align: center;
		}

		.barcode {
			width: 100%;
			max-width: 12rem;
			opacity: 0.25;
		}
	}

	/* ===== 小螢幕手機 (23.4375rem) ===== */
	@media (max-width: 23.4375rem) {
		.container {
			padding: 0 0.75rem;
		}

		.title {
			font-size: 1.5rem;
			padding-top: 3rem;
			margin-bottom: 1.5rem;
		}

		.ticket-mobile-header {
			padding: 0.875rem 1rem;
		}

		.mobile-title {
			font-size: 1.1rem;
		}

		.ticket-main-inner {
			padding: 1rem;
			padding-top: 0.5rem;
		}

		.icon-circle {
			width: 2.25rem;
			height: 2.25rem;
		}

		.ticket-title {
			font-size: 1.5rem;
		}

		.ticket-desc li {
			font-size: 0.85rem;
			margin-bottom: 0.375rem;
		}

		.btn-outline {
			padding: 0.625rem 1rem;
			font-size: 0.9rem;
		}
	}

	/* ===== 超小螢幕 (20rem) ===== */
	@media (max-width: 20rem) {
		.container {
			padding: 0 0.5rem;
		}

		.title {
			font-size: 1.25rem;
			padding-top: 2.5rem;
			margin-bottom: 1rem;
		}

		.ticket-mobile-header {
			padding: 0.75rem;
		}

		.mobile-title {
			font-size: 1rem;
		}

		.ticket-main-inner {
			padding: 0.75rem;
			padding-top: 0.5rem;
		}

		.icon-circle {
			width: 2rem;
			height: 2rem;
		}

		.ticket-title {
			font-size: 1.25rem;
		}

		.ticket-desc li {
			font-size: 0.8rem;
			margin-bottom: 0.3rem;
			padding-left: 0.75rem;
		}

		.btn-outline {
			padding: 0.5rem 0.75rem;
			font-size: 0.85rem;
		}
	}
</style>

<script>
	const initTicketCards = () => {
		const cards = document.querySelectorAll<HTMLElement>(".ticket-card");
		if (cards.length === 0) return () => {};

		const container = cards[0]?.closest(".ticket-container") as HTMLElement | null;
		if (!container) return () => {};
		if (container.dataset.ticketInit === "true") return () => {};
		container.dataset.ticketInit = "true";

		const MOBILE_BREAKPOINT = 768;

		const isMobile = (): boolean => {
			return window.innerWidth <= MOBILE_BREAKPOINT;
		};

		const updateAriaExpanded = (card: HTMLElement, expanded: boolean) => {
			const header = card.querySelector(".ticket-mobile-header");
			if (header) {
				header.setAttribute("aria-expanded", String(expanded));
			}
		};

		const handleMobileClick = (card: HTMLElement) => {
			if (card.classList.contains("active")) {
				card.classList.remove("active");
				updateAriaExpanded(card, false);
			} else {
				cards.forEach(c => {
					c.classList.remove("active");
					updateAriaExpanded(c, false);
				});
				card.classList.add("active");
				updateAriaExpanded(card, true);

				setTimeout(() => {
					card.scrollIntoView({ behavior: "smooth", block: "nearest" });
				}, 150);
			}
		};

		const handleDesktopClick = (card: HTMLElement) => {
			if (!card.classList.contains("active")) {
				cards.forEach(t => t.classList.remove("active"));
				card.classList.add("active");
			}
		};

		const fitText = (el: HTMLElement) => {
			const wrapper = el.parentElement;
			if (!wrapper) return;

			const maxSizeRem = parseFloat(el.dataset.maxSize || "4");
			let fontSizeRem = maxSizeRem;
			el.style.fontSize = `${fontSizeRem}rem`;

			const isVertical = el.classList.contains("ticket-vertical-text");
			const minSizeRem = isVertical ? 0.75 : 0.875;

			if (isVertical) {
				const containerHeight = wrapper.clientHeight || 400;
				while (el.scrollWidth > containerHeight && fontSizeRem > minSizeRem) {
					fontSizeRem -= 0.0625;
					el.style.fontSize = `${fontSizeRem}rem`;
				}
			} else {
				const containerWidth = wrapper.clientWidth;
				if (containerWidth === 0) return;

				while (el.scrollWidth > containerWidth && fontSizeRem > minSizeRem) {
					fontSizeRem -= 0.0625;
					el.style.fontSize = `${fontSizeRem}rem`;
				}
			}
		};

		const adjustAllFonts = () => {
			if (isMobile()) return;

			const titles = document.querySelectorAll<HTMLElement>(".ticket-title");
			const verticalTitles = document.querySelectorAll<HTMLElement>(".ticket-vertical-text");

			titles.forEach(fitText);
			verticalTitles.forEach(fitText);
		};

		const mobileHeaderHandlers = new Map<HTMLElement, (e: Event) => void>();
		const cardClickHandlers = new Map<HTMLElement, (e: Event) => void>();

		cards.forEach(card => {
			const mobileHeader = card.querySelector<HTMLElement>(".ticket-mobile-header");
			if (mobileHeader) {
				const handler = (e: Event) => {
					if (isMobile()) {
						e.preventDefault();
						e.stopPropagation();
						handleMobileClick(card);
					}
				};
				mobileHeaderHandlers.set(mobileHeader, handler);
				mobileHeader.addEventListener("click", handler);
			}

			const cardHandler = (e: Event) => {
				const target = e.target as HTMLElement;

				if (isMobile()) {
					return;
				}

				if (target.closest(".action-buttons")) {
					return;
				}

				handleDesktopClick(card);
			};
			cardClickHandlers.set(card, cardHandler);
			card.addEventListener("click", cardHandler);
		});

		let lastIsMobile = isMobile();

		const handleResize = () => {
			const currentIsMobile = isMobile();

			if (!currentIsMobile) {
				const titles = document.querySelectorAll<HTMLElement>(".ticket-title");
				const verticalTitles = document.querySelectorAll<HTMLElement>(".ticket-vertical-text");
				titles.forEach(el => (el.style.fontSize = ""));
				verticalTitles.forEach(el => (el.style.fontSize = ""));
			}

			adjustAllFonts();

			if (lastIsMobile !== currentIsMobile) {
				cards.forEach((card, index) => {
					if (index === 0) {
						card.classList.add("active");
						updateAriaExpanded(card, true);
					} else {
						card.classList.remove("active");
						updateAriaExpanded(card, false);
					}
				});
				lastIsMobile = currentIsMobile;
			}
		};

		let resizeTimeout: ReturnType<typeof setTimeout>;
		const resizeHandler = () => {
			clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(handleResize, 100);
		};
		window.addEventListener("resize", resizeHandler);

		const observer = new ResizeObserver(() => {
			requestAnimationFrame(adjustAllFonts);
		});

		cards.forEach(card => observer.observe(card));

		requestAnimationFrame(() => {
			setTimeout(adjustAllFonts, 50);
		});

		return () => {
			window.removeEventListener("resize", resizeHandler);
			clearTimeout(resizeTimeout);
			observer.disconnect();
			mobileHeaderHandlers.forEach((handler, header) => {
				header.removeEventListener("click", handler);
			});
			cardClickHandlers.forEach((handler, card) => {
				card.removeEventListener("click", handler);
			});
			container.dataset.ticketInit = "false";
		};
	};

	let cleanup: (() => void) | null = null;
	const mount = () => {
		cleanup?.();
		cleanup = initTicketCards();
	};

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", mount, { once: true });
	} else {
		mount();
	}

	const pageLoadHandler = () => mount();
	const beforeSwapHandler = () => {
		cleanup?.();
		document.removeEventListener("astro:page-load", pageLoadHandler);
		document.removeEventListener("astro:before-swap", beforeSwapHandler);
	};

	document.addEventListener("astro:page-load", pageLoadHandler);
	document.addEventListener("astro:before-swap", beforeSwapHandler);
</script>

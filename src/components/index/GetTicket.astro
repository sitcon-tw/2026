---
const tickets = [
	{
		id: "oscvpass",
		title: "OSCVPASS",
		color: "#e6d3a3",
		pill: "#77B55A",
		description: [
			"資格限制：對開源專案有貢獻者。",
			"在 2025/01/21 23:59 前申請且通過者，有機會可以搶到 SITCON 2025 開源貢獻票邀請碼。申請表單、申請資格及更詳細的申請說明，請參考開源貢獻者快速通關",
			"關於歷年來 OSCVPass 申請通過者的專案列表，請參考 OSCVPass 專案介紹。",
		],
		verticalTitle: "開源貢獻票",
	},
	{
		id: "general",
		title: "一般票",
		color: "#e0e0e0",
		pill: "#888888",
		description: ["一般大眾皆可參與。", "請關注 SITCON 官方網站及社群媒體以獲取最新售票資訊。"],
		verticalTitle: "一般票",
	},
	{
		id: "long-distance",
		title: "遠道而來票",
		color: "#c5a880",
		pill: "#5A4632",
		description: ["居住地距離會場較遠的參與者。", "需提供相關證明文件。"],
		verticalTitle: "遠道而來票",
	},
];

const lines = ["崴寶送了好多禮物給孟寶", "但是孟寶很糟糕", "只準備了這首歌想唱給崴寶聽", "這首歌送給崴寶", "一二三 三百天", "四五六 六百天", "不知不覺在一起永永遠遠"];

const fullLines = [...lines, ...lines];

function getRandomStyle() {
	const top = Math.floor(Math.random() * 90) + "%";
	const duration = Math.floor(Math.random() * 10) + 25 + "s";
	const delay = Math.floor(Math.random() * -30) + "s";
	return { top, duration, delay };
}
---

<section>
	<div class="container">
		<div class="title">
			<h1>索票方式</h1>
		</div>
		<div class="ticket-container">
			{
				tickets.map((ticket, index) => (
					<div class={`ticket-card ${index === 0 ? "active" : ""}`} data-id={ticket.id} style={`--bg-color: ${ticket.color}; --index: ${index};`}>
						<div class="ticket-content">
							<div class="ticket-main">
								<div class="ticket-header">
									<h2 class="ticket-title">{ticket.title}</h2>
									<span class="ticket-sitcon">SITCON 2026</span>
								</div>
								<ul class="ticket-desc">
									{ticket.description.map((item) => (
										<li>{item}</li>
									))}
								</ul>
								<div class="ticket-actions">
									<button class="btn-primary">立即索票</button>
									<button class="btn-secondary">加入行事曆</button>
								</div>
							</div>
							<div class="ticket-divider" />
							<div class="ticket-side">
								<div class="ticket-pill">{ticket.pill}</div>
								<div class="ticket-vertical-text">{ticket.verticalTitle}</div>
								<div class="ticket-footer-info">
									<div class="ticket-date">2026/03/28</div>
									<div class="ticket-location">中央研究院 人文社會科學館</div>
									<div class="ticket-sitcon-small">SITCON 2026</div>
								</div>
							</div>
						</div>
					</div>
				))
			}
		</div>
	</div>

	<div class="danmaku-container">
		{
			fullLines.map(line => {
				const style = getRandomStyle();
				return (
					<p class="danmaku-item" style={`top: ${style.top}; animation-duration: ${style.duration}; animation-delay: ${style.delay};`}>
						{line}
					</p>
				);
			})
		}
	</div>
</section>

<style>
	section {
		position: relative;
		width: 100%;
		height: 56rem;
		overflow: hidden;
	}

	.container {
		position: relative;
		z-index: 10;
		display: flex;
		flex-direction: column;
		align-items: center;
		height: 100%;
	}

	.title {
		font-size: 2.25rem;
		padding-top: 6rem;
		color: white;
		text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.title h1 {
		font-weight: 700;
	}

	.ticket-container {
		position: relative;
		width: 67rem;
		height: 30rem;
		margin-top: 2rem;
		perspective: 1000px;
	}

	.ticket-card {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: var(--bg-color);
		border-radius: 20px;
		box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
		cursor: pointer;
		overflow: hidden;
		transform-origin: right center;
		mask-image: radial-gradient(circle at calc(100% - 12rem) 0, transparent 15px, black 16px),
			radial-gradient(circle at calc(100% - 12rem) 100%, transparent 15px, black 16px);
		-webkit-mask-image: radial-gradient(circle at calc(100% - 12rem) 0, transparent 15px, black 16px),
			radial-gradient(circle at calc(100% - 12rem) 100%, transparent 15px, black 16px);
		mask-composite: intersect;
		-webkit-mask-composite: source-in;
	}

	.ticket-card.active {
		cursor: default;
	}

	.ticket-content {
		display: flex;
		height: 100%;
		width: 100%;
	}

	.ticket-main {
		flex: 1;
		padding: 3rem;
		display: flex;
		flex-direction: column;
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.ticket-card.active .ticket-main {
		opacity: 1;
	}

	.ticket-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 1.5rem;
	}

	.ticket-title {
		font-size: 5rem;
		font-weight: 900;
		color: #333;
		line-height: 1;
	}

	.ticket-sitcon {
		font-size: 1.25rem;
		font-weight: 700;
		color: #333;
	}

	.ticket-desc {
		list-style: none;
		padding: 0;
		color: #444;
		font-size: 1.1rem;
		line-height: 1.6;
		flex: 1;
	}

	.ticket-desc li {
		margin-bottom: 0.75rem;
		position: relative;
		padding-left: 1.25rem;
	}

	.ticket-desc li::before {
		content: "•";
		position: absolute;
		left: 0;
		font-weight: bold;
	}

	.ticket-actions {
		display: flex;
		gap: 1.5rem;
		margin-top: 1rem;
	}

	.btn-primary,
	.btn-secondary {
		padding: 0.75rem 2.5rem;
		border-radius: 999px;
		font-size: 1.5rem;
		font-weight: 700;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.btn-primary {
		background: transparent;
		border: 2px solid #333;
		color: #333;
	}

	.btn-primary:hover {
		background: #333;
		color: white;
	}

	.btn-secondary {
		background: transparent;
		border: 2px solid rgba(0, 0, 0, 0.3);
		color: #333;
	}

	.btn-secondary:hover {
		border-color: #333;
	}

	.ticket-divider {
		width: 0;
		border-left: 2px dashed rgba(0, 0, 0, 0.2);
		margin: 2rem 0;
	}

	.ticket-side {
		width: 12rem;
		padding: 2rem 1rem;
		display: flex;
		flex-direction: column;
		align-items: center;
		position: relative;
	}

	.ticket-pill {
		background: rgba(0, 0, 0, 0.05);
		border: 1px solid rgba(0, 0, 0, 0.1);
		padding: 0.2rem 0.8rem;
		border-radius: 999px;
		font-size: 0.875rem;
		font-family: monospace;
		margin-bottom: 2rem;
		color: #333;
		transform: rotate(90deg);
	}

	.ticket-vertical-text {
		writing-mode: vertical-rl;
		font-size: 3.5rem;
		font-weight: 900;
		color: #333;
		letter-spacing: 0.5rem;
		flex: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		text-orientation: upright;
	}

	.ticket-footer-info {
		font-size: 0.75rem;
		color: #333;
		text-align: right;
		margin-top: auto;
		display: flex;
		flex-direction: column;
		gap: 0.2rem;
		opacity: 0;
		transition: opacity 0.3s ease;
		transform: rotate(90deg);
		transform-origin: bottom right;
		position: absolute;
		bottom: 1rem;
		right: 2.5rem;
		white-space: nowrap;
		width: 15rem;
	}

	.ticket-card.active .ticket-footer-info {
		opacity: 1;
	}

	.ticket-sitcon-small {
		font-weight: 700;
		margin-top: 0.25rem;
	}

	.danmaku-container {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		pointer-events: none;
		z-index: 1;
		user-select: none;
	}

	.danmaku-item {
		position: absolute;
		left: 100%;
		white-space: nowrap;
		font-size: 3rem;
		font-weight: bold;
		color: white;
		opacity: 0.15;
		animation-name: fly;
		animation-timing-function: linear;
		animation-iteration-count: infinite;
	}

	@keyframes fly {
		from {
			transform: translateX(0);
		}
		to {
			transform: translateX(-150vw);
		}
	}
</style>

<script>
	import { gsap } from "gsap";

	const cards = document.querySelectorAll(".ticket-card");
	const container = document.querySelector(".ticket-container");
	const sideWidth = 12 * 16; // 12rem
	const overlap = 50;
	let currentActiveIndex = 0;

	function updateCards(activeIndex: number) {
		if (!container) return;
		currentActiveIndex = activeIndex;
		const containerWidth = container.getBoundingClientRect().width;

		cards.forEach((card, index) => {
			const htmlCard = card as HTMLElement;
			if (index === activeIndex) {
				gsap.to(htmlCard, {
					x: 0,
					zIndex: cards.length,
					rotationY: 0,
					scale: 1,
					duration: 0.8,
					ease: "power4.out",
				});
				htmlCard.classList.add("active");
			} else if (index > activeIndex) {
				// Cards to the right
				const offset = (index - activeIndex - 1) * overlap;
				const targetX = containerWidth - sideWidth + offset;
				gsap.to(htmlCard, {
					x: targetX,
					zIndex: cards.length - index,
					rotationY: -10,
					scale: 0.95,
					duration: 0.8,
					ease: "power4.out",
				});
				htmlCard.classList.remove("active");
			} else {
				// Cards to the left
				gsap.to(htmlCard, {
					x: -containerWidth,
					zIndex: index,
					rotationY: 10,
					duration: 0.8,
					ease: "power4.out",
				});
				htmlCard.classList.remove("active");
			}
		});
	}

	cards.forEach((card, index) => {
		card.addEventListener("click", () => {
			updateCards(index);
		});

		card.addEventListener("mouseenter", () => {
			if (index > currentActiveIndex) {
				gsap.to(card, {
					x: "-=30",
					duration: 0.3,
					ease: "power2.out",
				});
			}
		});

		card.addEventListener("mouseleave", () => {
			if (index > currentActiveIndex) {
				updateCards(currentActiveIndex);
			}
		});
	});

	// Initial state
	updateCards(0);
</script>

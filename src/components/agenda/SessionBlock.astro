---
interface Speaker {
	name: string;
	avatar?: string;
	description?: string;
}

const { id: sessionId, type, name, description, speakers, tags, leftPercent, widthPercent, venue, startTime, endTime, slidoLink, slidesLink, notesLink, lang = "zh" } = Astro.props;

// Helper function to get speaker name
function getSpeakerName(speaker: string | Speaker): string {
	return typeof speaker === "string" ? speaker : speaker.name;
}
---

<div
	class={`session-block ${type} ${!description || description === "" ? "no-description" : ""}`}
	style={`left: calc(${leftPercent}% + 0.25rem); width: calc(${widthPercent}% - 0.1rem)`}
	data-session-id={sessionId}
	data-session-type={type}
	data-session-name={name}
	data-session-description={description || ""}
	data-session-venue={venue || ""}
	data-session-start-time={startTime || ""}
	data-session-end-time={endTime || ""}
	data-session-slido={slidoLink || ""}
	data-session-slides={slidesLink || ""}
	data-session-notes={notesLink || ""}
	data-session-lang={lang}
	data-session-speakers={JSON.stringify(speakers.map((s: string | Speaker) => (typeof s === "string" ? { name: s } : s)))}
	data-session-tags={JSON.stringify(tags)}
>
	<div class="session-bookmark" aria-label="Bookmark session" role="button" tabindex="0" data-session-id={sessionId}></div>
	<div class="session-content">
		<div class="session-name">{name}</div>
		<div class="session-info-wrapper">
			{
				speakers.length > 0 && (
					<div class="session-speaker">
						{speakers.map((speaker: string | Speaker, index: number) => (
							<>
								{index > 0 && ", "}
								{getSpeakerName(speaker)}
							</>
						))}
					</div>
				)
			}
			{
				tags.length > 0 && (
					<div class="session-tags">
						{tags.map((tag: string) => (
							<span class="session-tag">#{tag}</span>
						))}
					</div>
				)
			}
		</div>
	</div>
</div>

<style>
	.session-block {
		position: absolute;
		height: calc(100% - 0.1rem);
		border-radius: 0.5rem;
		padding: 1rem;
		overflow-x: hidden;
		cursor: pointer;
		transition:
			transform 0.2s,
			filter 0.2s,
			box-shadow 0.2s;
		z-index: 1;
		box-sizing: border-box;
	}

	.session-block.no-description {
		cursor: default;
	}

	.session-block:hover {
		transform: scale(1.025);
		filter: brightness(1.2);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		z-index: 10;
	}

	.session-block.no-description:hover {
		transform: none;
		filter: none;
		box-shadow: none;
		z-index: 1;
	}

	.session-block.keynote {
		background-color: #8d5e00;
	}

	.session-block.presentation {
		background-color: #484848;
	}

	.session-block.undefined {
		background-color: #5a4a7a;
	}

	.session-block.espresso {
		background-color: #bababa;
		color: #3c2d0e;
	}

	.session-block.espresso .session-bookmark {
		opacity: 0.5;
	}

	.session-block.generic {
		background-color: #1d1d1d;
		z-index: 3;
	}

	.session-bookmark {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		width: 1.5rem;
		height: 1.5rem;
		background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 21l-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z'/%3E%3C/svg%3E");
		background-size: contain;
		background-repeat: no-repeat;
		opacity: 0.7;
		z-index: 2;
		cursor: pointer;
	}

	.session-bookmark.is-bookmarked {
		opacity: 1;
		background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='white' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 21l-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z'/%3E%3C/svg%3E");
	}

	.session-content {
		height: 100%;
		display: flex;
		flex-direction: column;
		justify-content: center;
		gap: 0.5rem;
		min-width: 20rem;
		overflow-x: hidden;
	}

	.session-name {
		font-size: 1rem;
		font-weight: bold;
		line-height: 1.3;
		min-width: 20rem;
		word-wrap: break-word;
		overflow-wrap: break-word;
		overflow-x: hidden;
	}

	.session-info-wrapper {
		display: flex;
		flex-direction: row;
		align-items: center;
		gap: 0.25rem;
		width: 100%;
		min-width: 20rem;
		overflow-x: hidden;
		scrollbar-width: none;
		-ms-overflow-style: none;
	}

	.session-info-wrapper::-webkit-scrollbar {
		display: none;
	}

	.session-speaker {
		font-size: 0.875rem;
		opacity: 0.9;
		white-space: nowrap;
		flex-shrink: 0;
		min-width: 0;
	}

	.session-tags {
		display: flex;
		flex-wrap: nowrap;
		gap: 0.25rem;
		margin-top: auto;
		min-width: 0;
		flex-shrink: 0;
	}

	.session-tag {
		font-size: 0.75rem;
		color: #36ff62;
		white-space: nowrap;
		overflow: hidden;
		flex-shrink: 0;
	}

	.session-links {
		display: flex;
		gap: 0.5rem;
		margin-top: auto;
		padding-top: 0.5rem;
		border-top: 1px solid rgba(255, 255, 255, 0.1);
	}

	.session-link {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 2rem;
		height: 2rem;
		border-radius: 0.25rem;
		background-color: rgba(255, 255, 255, 0.1);
		color: currentColor;
		text-decoration: none;
		transition:
			background-color 0.2s,
			transform 0.2s;
	}

	.session-link:hover {
		background-color: rgba(255, 255, 255, 0.2);
		transform: scale(1.1);
	}

	.session-link svg {
		width: 1rem;
		height: 1rem;
	}

	@media (max-width: 768px) {
		.session-block {
			padding: 0.75rem;
		}

		.session-name {
			font-size: 0.875rem;
		}
	}
</style>

<script>
	const STORAGE_KEY = "sitcon2026:agendaBookmarks";

	function readBookmarks(): Set<string> {
		try {
			const raw = localStorage.getItem(STORAGE_KEY);
			if (!raw) return new Set();
			const arr = JSON.parse(raw);
			if (!Array.isArray(arr)) return new Set();
			return new Set(arr.filter(x => typeof x === "string"));
		} catch {
			return new Set();
		}
	}

	function writeBookmarks(bookmarks: Set<string>) {
		try {
			localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(bookmarks)));
		} catch {
			// ignore
		}
	}

	function updateBookmarkUI(bookmarkEl: Element, isBookmarked: boolean) {
		bookmarkEl.classList.toggle("is-bookmarked", isBookmarked);
	}

	// Add click handler to open modal
	document.addEventListener("DOMContentLoaded", () => {
		const sessionBlocks = document.querySelectorAll(".session-block");
		const bookmarks = readBookmarks();

		sessionBlocks.forEach(block => {
			// Init bookmark state
			const bookmarkEl = block.querySelector(".session-bookmark");
			const sessionId = block.getAttribute("data-session-id") || "";
			if (bookmarkEl && sessionId) {
				updateBookmarkUI(bookmarkEl, bookmarks.has(sessionId));

				const toggle = (e: Event) => {
					e.preventDefault();
					e.stopPropagation();
					if (!sessionId) return;
					if (bookmarks.has(sessionId)) bookmarks.delete(sessionId);
					else bookmarks.add(sessionId);
					writeBookmarks(bookmarks);
					updateBookmarkUI(bookmarkEl, bookmarks.has(sessionId));
					document.dispatchEvent(new CustomEvent("agendaBookmarksChanged"));
				};

				bookmarkEl.addEventListener("click", toggle);
				bookmarkEl.addEventListener("keydown", e => {
					if ("key" in e && (e.key === "Enter" || e.key === " ")) toggle(e);
				});
			}

			block.addEventListener("click", e => {
				// Don't trigger if clicking on a link
				if ((e.target as HTMLElement).closest("a")) {
					return;
				}

				// Don't trigger if clicking the bookmark
				if ((e.target as HTMLElement).closest(".session-bookmark")) {
					return;
				}

				const id = block.getAttribute("data-session-id") || "";
				const type = block.getAttribute("data-session-type") || "";
				const name = block.getAttribute("data-session-name") || "";
				const description = block.getAttribute("data-session-description") || "";

				if (!description || description === "") {
					return;
				}

				const venue = block.getAttribute("data-session-venue") || "";
				const startTime = block.getAttribute("data-session-start-time") || "";
				const endTime = block.getAttribute("data-session-end-time") || "";
				const slidoLink = block.getAttribute("data-session-slido") || "";
				const slidesLink = block.getAttribute("data-session-slides") || "";
				const notesLink = block.getAttribute("data-session-notes") || "";
				const lang = block.getAttribute("data-session-lang") || "zh";

				// Get speakers from data attribute
				const speakersData = block.getAttribute("data-session-speakers");
				let speakers: Array<{ name: string; avatar?: string }> = [];
				if (speakersData) {
					try {
						speakers = JSON.parse(speakersData);
					} catch (e) {
						console.error("Failed to parse speakers data:", e);
					}
				}

				// Get tags from data attribute
				const tagsData = block.getAttribute("data-session-tags");
				let tags: string[] = [];
				if (tagsData) {
					try {
						tags = JSON.parse(tagsData);
					} catch (e) {
						console.error("Failed to parse tags data:", e);
					}
				}

				// Get advertisement data if available (stored in data attribute as JSON)
				const adData = block.getAttribute("data-session-advertisement");
				let advertisement = undefined;
				if (adData) {
					try {
						advertisement = JSON.parse(adData);
					} catch (e) {
						console.error("Failed to parse advertisement data:", e);
					}
				}

				// Trigger modal update event
				const event = new CustomEvent("openSessionModal", {
					detail: {
						id,
						type,
						name,
						description,
						speakers,
						tags,
						venue,
						startTime,
						endTime,
						slidoLink,
						slidesLink,
						notesLink,
						advertisement,
						lang
					}
				});
				document.dispatchEvent(event);
			});
		});
	});

	// Sync bookmark icon when toggled from modal ribbon
	document.addEventListener("bookmarksChanged", ((e: CustomEvent) => {
		const sessionId = e.detail?.sessionId;
		if (!sessionId) return;
		const block = document.querySelector(`.session-block[data-session-id="${CSS.escape(sessionId)}"]`);
		const bookmarkEl = block?.querySelector(".session-bookmark");
		if (bookmarkEl) {
			updateBookmarkUI(bookmarkEl, readBookmarks().has(sessionId));
		}
	}) as EventListener);
</script>

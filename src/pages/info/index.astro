---
import Layout from "@/layout/Layout.astro";
import Footer from "@/components/Footer.astro";
import { useTranslations } from "@/utils/i18n";
import { X } from "@lucide/astro";
const lang = Astro.props.lang ?? "zh";
const i18n = useTranslations(lang);
const { info } = i18n;
const { sections } = info;
---

<Layout title={lang === "en" ? "Event Info - SITCON 2026" : "活動資訊 - SITCON 2026"} lang={lang}>
	<header>
		<div class="hero-content">
			<h1 class="hero-title">{info.mainHeading}</h1>
			<p set:html={info.mainDetails.join("<br />")} />
			<button class="hero-button" data-open-transport>{info.mainButton}</button>
		</div>

		<button class="hero-into-button" id="into-academia-sinica">{info.intoAcademiaSinica}</button>
		<div class="hero-bg" aria-hidden="true">
			<img src="/2026/img/academia-sinica.svg" alt="" class="hero-bg-img" />
		</div>
	</header>

	<main>
		<div class="activities-container">
			<h2 class="text-reveal-title">{info.activitiesHeading}</h2>
			{
				sections?.map((section: { title: string; activities?: { title: string; body?: string; image: { url: string; alt?: string; position?: string } }[] }) => (
					<div class="activities-section">
						<h3 class="text-reveal-title">{section.title}</h3>

						{section.activities?.map((activity: { title: string; body?: string; image: { url: string; alt?: string; position?: string } }) => {
							return (
								<div class="activity">
									<img class="activity-image" src={activity.image.url} alt={activity.image.alt ?? activity.title} loading="lazy" />
									<div>
										<h4 class="text-reveal-title">{activity.title}</h4>
										{activity.body
											?.split("\n\n")
											.map((paragraph: string) => paragraph.trim())
											.filter(Boolean)
											.map((paragraph: string) => (
												<p class="text-reveal-paragraph" set:html={paragraph} />
											))}
									</div>
								</div>
							);
						})}
					</div>
				))
			}
		</div>
	</main>

	<dialog class="modal" data-transport-dialog>
		<div class="modal-card">
			<div class="modal-header">
				<h2 class="modal-title">{info.transport.title}</h2>
				<button class="modal-x" type="button" data-close-transport><X /></button>
			</div>

			<div class="modal-body">
				<div class="modal-button-container" role="tablist" aria-label={info.transport.title}>
					<button class="modal-button is-active" type="button" data-transport-tab="shuttle" role="tab" aria-selected="true">{info.transport.tabs.shuttle}</button>

					<button class="modal-button" type="button" data-transport-tab="public" role="tab" aria-selected="false">{info.transport.tabs.public}</button>

					<button class="modal-button" type="button" data-transport-tab="drive" role="tab" aria-selected="false">{info.transport.tabs.drive}</button>
				</div>

				<section class="transport-panel" data-transport-panel="shuttle" role="tabpanel">
					<div class="transport-route">
						<div class="transport-route-left">{info.transport.shuttle.from}</div>

						<div class="transport-route-line" aria-hidden="true"></div>

						<div class="transport-route-right">{info.transport.shuttle.to}</div>
					</div>

					<div class="transport-card">
						<p>{info.transport.shuttle.location}</p>
						<p>{info.transport.shuttle.time}</p>
						<p>{info.transport.shuttle.interval}</p>
					</div>
				</section>

				<section class="transport-panel" data-transport-panel="public" role="tabpanel" hidden>
					<div class="transport-section">
						<h3 class="transport-section-title">{info.transport.public.youbike.title}</h3>
						<p class="transport-section-desc">{info.transport.public.youbike.description}</p>
						<div class="transport-stations">
							{info.transport.public.youbike.stations.map((station: string) => <span class="transport-station-tag">{station}</span>)}
						</div>
					</div>

					<div class="transport-section">
						<h3 class="transport-section-title">{info.transport.public.bus.title}</h3>
						{
							info.transport.public.bus.routes.map((route: { from: string; description: string; to: string; buses: string[] }) => (
								<div class="transport-card">
									<div class="transport-route">
										<div class="transport-route-left">{route.from}</div>
										<div class="transport-route-line" aria-hidden="true" />
										<div class="transport-route-right">{route.to}</div>
									</div>
									<p class="transport-route-desc">{route.description}</p>
									<div class="transport-buses">
										{route.buses.map((bus: string) => (
											<span class="transport-bus-tag">{bus}</span>
										))}
									</div>
								</div>
							))
						}
					</div>
				</section>

				<section class="transport-panel" data-transport-panel="drive" role="tabpanel" hidden>
					<div class="transport-card">
						<h3 class="transport-card-title">{info.transport.drive.car.title}</h3>
						<p set:html={info.transport.drive.car.description} />
					</div>

					<div class="transport-card">
						<h3 class="transport-card-title">{info.transport.drive.motorcycle.title}</h3>
						<p set:html={info.transport.drive.motorcycle.description} />
					</div>

					<div class="transport-references">
						<h4 class="transport-references-title">{info.transport.drive.referencesTitle}</h4>
						<ul class="transport-references-list">
							{
								info.transport.drive.references.map((ref: { name: string; url: string }) => (
									<li>
										<a href={ref.url} target="_blank" rel="noopener noreferrer">
											{ref.name}
										</a>
									</li>
								))
							}
						</ul>
					</div>
				</section>
			</div>
		</div>
	</dialog>

	<Footer />
</Layout>

<script>
	window.addEventListener("DOMContentLoaded", () => {
		// Modal logic
		const dialog = document.querySelector<HTMLDialogElement>("[data-transport-dialog]");
		const openButton = document.querySelector<HTMLButtonElement>("[data-open-transport]");
		const closeButton = document.querySelector<HTMLButtonElement>("[data-close-transport]");

		if (!dialog || !openButton || !closeButton) return;

		const tabs = Array.from(document.querySelectorAll<HTMLButtonElement>("[data-transport-tab]"));
		const panels = Array.from(document.querySelectorAll<HTMLElement>("[data-transport-panel]"));

		const activateTab = (name: string) => {
			tabs.forEach(btn => {
				const active = btn.getAttribute("data-transport-tab") === name;
				btn.classList.toggle("is-active", active);
				btn.setAttribute("aria-selected", active ? "true" : "false");
			});

			panels.forEach(panel => {
				const active = panel.getAttribute("data-transport-panel") === name;
				if (active) panel.removeAttribute("hidden");
				else panel.setAttribute("hidden", "");
			});
		};

		openButton.addEventListener("click", () => {
			if (typeof dialog.showModal === "function") dialog.showModal();
			else dialog.setAttribute("open", "");

			activateTab("shuttle");
		});

		closeButton.addEventListener("click", () => dialog.close());

		dialog.addEventListener("click", (e: MouseEvent) => {
			if (e.target === dialog) dialog.close();
		});

		tabs.forEach(btn => {
			btn.addEventListener("click", () => {
				const name = btn.getAttribute("data-transport-tab");
				if (name) activateTab(name);
			});
		});

		// Into Academia Sinica button logic
		const intoBtn = document.getElementById("into-academia-sinica");
		const hero = document.querySelector<HTMLElement>("header.hero");
		const heroContent = hero?.querySelector<HTMLElement>(".hero-content");
		const main = document.querySelector<HTMLElement>("main.activities");
		const footer = document.querySelector<HTMLElement>("footer");

		let exiting = false;

		intoBtn?.addEventListener("click", () => {
			if (exiting) return;
			exiting = true;

			const html = document.documentElement;
			html.style.scrollBehavior = "auto";

			document.documentElement.scrollTop = 0;
			document.body.scrollTop = 0;
			window.scrollTo(0, 0);

			const scrollY = window.scrollY;
			document.body.style.position = "fixed";
			document.body.style.top = `-${scrollY}px`;
			document.body.classList.add("page-lock");

			if (hero) {
				const rect = hero.getBoundingClientRect();
				hero.style.height = `${rect.height}px`;
				hero.style.paddingTop = getComputedStyle(hero).paddingTop;
				hero.style.paddingBottom = getComputedStyle(hero).paddingBottom;
			}

			heroContent?.classList.add("fade-out");
			main?.classList.add("fade-out");
			footer?.classList.add("fade-out");
			intoBtn.classList.add("fade-out");

			if (hero) hero.style.height = "100vh";
			if (hero) hero.style.width = "100vw";

			const href = "/2026/info/academia-sinica/";

			setTimeout(() => {
				window.location.href = href;
			}, 300);
		});
	});
</script>

<style>
	header {
		position: relative;
		overflow: hidden;
		display: flex;
		align-items: center;
		justify-content: center;
		padding-block: 13rem;
	}

	.hero-content {
		position: relative;
		display: flex;
		flex-direction: column;
		gap: 2.69rem;
		z-index: 2;
		align-items: center;
		text-align: center;
	}

	.hero-bg {
		position: absolute;
		inset: 0;
		z-index: 0;
		pointer-events: none;
	}

	.hero-bg-img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.hero-button {
		padding: 1rem 2rem;
		font-size: 1.25rem;
		font-weight: bold;
		background-color: var(--coffee);
		color: #ffefcf;
		border-radius: 10rem;
		border: none;
		cursor: pointer;
	}

	.hero-into-button {
		padding: 1rem 2rem;
		font-size: 1rem;
		font-weight: bold;
		background-color: #ffffff4f;
		color: #ffffffcc;
		border-radius: 10rem;
		border: none;
		cursor: pointer;
		position: absolute;
		bottom: 1.63rem;
		right: 2.19rem;
		z-index: 2;
		opacity: 80%;
	}

	main {
		background-color: var(--silence-white);
		color: var(--coffee);
		padding: 3rem 2rem;
	}

	.activities-container {
		max-width: var(--content-max-width);
		margin-inline: auto;
	}

	.activities-section {
		border-top: 2px solid var(--coffee);
		padding: 2rem 0rem;
	}

	h2 {
		font-size: 4rem;
		margin: 2rem;
	}

	h3 {
		font-size: 3rem;
		margin: 1rem 2rem 2.5rem;
	}

	h4 {
		font-size: 2rem;
		margin-bottom: 1rem;
	}

	.activity {
		padding-inline: 2rem;
		margin: 2rem;
		gap: 2.75rem;
		display: flex;
		align-items: center;
	}

	.activity:nth-child(odd) {
		flex-direction: row-reverse;
	}

	.activity img {
		width: 18.75rem;
		height: 18.75rem;
		max-width: 100%;
		object-fit: cover;
	}

	:global(table) {
		display: none;
		width: 100%;
		border-collapse: separate;
		border-spacing: 0;
		margin: 1.5rem 0;
		background: #fff;
		border-radius: 0.75rem;
		overflow: hidden;
		border: 2px solid rgba(180, 148, 76, 0.2);
	}

	:global(table th),
	:global(table td) {
		padding: 1rem 1.25rem;
		text-align: left;
		border-bottom: 1px solid rgba(180, 148, 76, 0.15);
	}

	:global(table th) {
		background: rgba(180, 148, 76, 0.15);
		font-weight: bold;
		font-size: 0.95rem;
		text-transform: uppercase;
		letter-spacing: 0.03em;
		color: #6b5528;
		border-bottom: 2px solid rgba(180, 148, 76, 0.3);
	}

	:global(table tbody tr) {
		transition: all 0.2s ease;
	}

	:global(table tbody tr:hover) {
		background: rgba(180, 148, 76, 0.06);
		transform: translateX(2px);
	}

	:global(table tbody tr:last-child td) {
		border-bottom: none;
	}

	:global(table td) {
		font-size: 0.9375rem;
		color: var(--coffee);
	}

	:global(table tr td:first-child) {
		font-weight: 500;
	}

	.modal {
		display: none;
		border: none;
		padding: 0;
		background: transparent;
		color: var(--silence-white);

		width: 100%;
		max-width: none;
		height: 100%;
		max-height: none;
		position: fixed;
	}

	.modal[open] {
		display: grid;
		place-items: center;
	}
	:root:has(dialog[open]),
	body:has(dialog[open]) {
		height: 100vh;
		overflow: hidden;
	}

	.modal::backdrop {
		background: rgba(0, 0, 0, 0.45);
		backdrop-filter: blur(2px);
	}

	.modal-card {
		width: min(50rem, calc(100vw - 2rem));
		padding: 4rem;
		border-radius: 1rem;
		background: rgba(0, 0, 0, 0.44);
		margin: 1rem 0;
	}

	.modal-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 1.25rem 1.25rem 0.75rem;
	}

	.modal-button {
		background: linear-gradient(90deg, #edb73d 0%, #d1a643 25%, #c39d47 50%, #c09b48 75%, #b6944acc 100%);
		border: 1px solid var(--copper);
		border-radius: 0.75rem;
		cursor: pointer;
		font-size: 1.125rem;
		padding: 0.625rem 1.75rem;
		color: #12121280;
		font-weight: bold;
	}

	.modal-button.is-active {
		filter: brightness(1.05);
		outline: 2px solid rgba(255, 255, 255, 0.35);
		outline-offset: 2px;
	}

	.modal-button-container {
		display: flex;
		gap: 1rem;
		align-items: center; /* horizontal center for column flex */
		justify-content: space-between;
	}

	.modal-title {
		font-size: 2rem;
	}

	.modal-x {
		border: none;
		background: rgb(0, 0, 0);
		color: var(--silence-white);

		width: 2.25rem;
		height: 2.25rem;
		border-radius: 999px;

		display: grid;
		place-items: center;

		cursor: pointer;
		padding: 0;
		line-height: 0;
	}

	.modal-x:hover {
		background: rgba(255, 255, 255, 0.1);
	}

	.modal-body {
		padding: 1rem 1.25rem 1.25rem;
		display: flex;
		flex-direction: column;
		gap: 1.25rem;
	}

	.transport-panel {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.transport-panel[hidden] {
		display: none !important;
	}

	.transport-route {
		display: flex;
		align-items: center;
		flex-wrap: wrap;
		gap: 1.25rem;
		color: var(--silence-white);
		font-weight: 500;
		font-size: 1.25rem;
	}

	.transport-route-left,
	.transport-route-right {
		white-space: nowrap;
	}

	.transport-route-line {
		position: relative;
		flex: 1;
		height: 2px;
		background: var(--silence-white);
		border-radius: 999px;
		min-width: 3rem;
	}

	.transport-route-line::after {
		content: "";
		position: absolute;
		right: 0;
		top: 50%;
		width: 10px;
		height: 10px;
		border-right: 2px solid var(--silence-white);
		border-top: 2px solid var(--silence-white);
		transform: translateY(-50%) rotate(45deg);
	}

	.transport-card {
		border-radius: 0.5rem;
		padding: 1.25rem 1.5rem;
		background: rgba(0, 0, 0, 0.25);
		border: 1px solid rgba(255, 255, 255, 0.3);
	}

	.transport-card p {
		margin: 0;
		font-size: 1rem;
		color: var(--silence-white);
		font-weight: 500;
	}

	.transport-card :global(a) {
		color: #edb73d;
		text-decoration: underline;
	}

	.transport-card-title {
		font-size: 1.125rem;
		font-weight: bold;
		color: var(--silence-white);
		margin: 0 0 0.75rem 0;
	}

	.transport-section {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.transport-section-title {
		font-size: 1.25rem;
		font-weight: bold;
		color: var(--silence-white);
		margin: 0;
	}

	.transport-section-desc {
		font-size: 0.9375rem;
		color: rgba(255, 255, 255, 0.8);
		margin: 0;
	}

	.transport-stations {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.transport-station-tag {
		background: rgba(255, 255, 255, 0.15);
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: 0.5rem;
		padding: 0.375rem 0.75rem;
		font-size: 0.875rem;
		color: var(--silence-white);
	}

	.transport-route-desc {
		font-size: 0.9375rem;
		color: rgba(255, 255, 255, 0.8);
		margin: 0.75rem 0;
	}

	.transport-buses {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-top: 0.5rem;
	}

	.transport-bus-tag {
		background: linear-gradient(90deg, #edb73d 0%, #c09b48 100%);
		border-radius: 0.375rem;
		padding: 0.25rem 0.625rem;
		font-size: 0.875rem;
		color: #121212;
		font-weight: 600;
	}

	.transport-references {
		margin-top: 0.5rem;
	}

	.transport-references-title {
		font-size: 1rem;
		font-weight: bold;
		color: var(--silence-white);
		margin: 0 0 0.5rem 0;
	}

	.transport-references-list {
		margin: 0;
		padding-left: 1.25rem;
	}

	.transport-references-list li {
		font-size: 0.9375rem;
		color: var(--silence-white);
		margin-bottom: 0.25rem;
	}

	.transport-references-list a {
		color: #edb73d;
		text-decoration: underline;
	}

	@media (max-width: 880px) {
		.hero-button {
			opacity: 80%;
		}

		header {
			flex-direction: column;
			gap: 1rem;
			padding-block: 10rem;
		}

		.hero-into-button {
			position: static;
			bottom: auto;
			right: auto;

			margin-top: 0.5rem;
		}

		.activity {
			display: block;
			margin: 0 0 3rem 0;
			padding: 0;
		}

		h3 {
			margin-inline: 0;
		}

		.activity img {
			width: 100%;
			height: auto;
			max-height: 20rem;
			aspect-ratio: 35 / 20;
			object-fit: cover;
			border-radius: 0.75rem;
			margin-bottom: 2rem;
		}

		.activities-section {
			padding: 1.5rem 0rem;
		}
	}

	/* For modal */
	@media (max-width: 730px) {
		.modal-card {
			padding: 0.5rem;
		}
		.transport-route-left,
		.transport-route-right {
			white-space: normal;
		}
		.modal-button-container {
			flex-direction: column;
			gap: 0.75rem;
		}

		.modal-button {
			width: 100%;
		}
	}

	.page-lock {
		overflow: hidden;
	}

	.hero {
		transition:
			height 700ms ease,
			padding-top 700ms ease,
			padding-bottom 700ms ease;
		will-change: height, padding-top, padding-bottom;
	}

	.fade-out {
		opacity: 0;
		transform: translateY(10px);
		transition:
			opacity 700ms ease,
			transform 700ms ease;
		pointer-events: none;
	}

	.hero-content,
	.activities,
	footer,
	.hero-into-button {
		transition:
			opacity 700ms ease,
			transform 700ms ease;
	}

	.hero-bg :global(img.hero-bg-img) {
		transition: transform 700ms ease;
		will-change: transform;
	}

	@media (prefers-reduced-motion: reduce) {
		.hero {
			transition: none;
		}

		.fade-out {
			transition: none;
		}

		.hero-content,
		.activities,
		footer,
		.hero-into-button {
			transition: none;
		}

		.hero-bg :global(img.hero-bg-img) {
			transition: none;
		}

		:global(table tbody tr) {
			transition: none;
		}
	}
</style>

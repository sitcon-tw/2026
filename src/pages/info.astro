---
import Layout from "@/layout/Layout.astro";
import Footer from "@/components/Footer.astro";
import zhHant from "@/i18n/zh-Hant.json";
import { Image } from "astro:assets";
import academiaSinica from "../assets/academia-sinica.svg";
import { X } from "@lucide/astro";

const { info } = zhHant;
const { sections } = info;

const activityImages = import.meta.glob<{ default: ImageMetadata }>("/src/assets/activities/*.{png,jpg,jpeg,webp,gif,svg}", { eager: true });

function getActivityImage(file: string): ImageMetadata {
	const key = `/src/assets/activities/${file}`;
	const mod = activityImages[key];
	if (!mod) throw new Error(`Missing activity image: ${key}`);
	return (mod as any).default;
}
---

<Layout>
	<header class="hero">
		<div class="hero-content">
			<h1 class="hero-title">{info.mainHeading}</h1>

			<div class="hero-details">
				{info.mainDetails.map(detail => <p class="hero-detail">{detail}</p>)}
			</div>

			<button class="hero-button" data-open-transport>{info.mainButton}</button>
		</div>

		<button class="hero-into-button" id="into-academia-sinica">{info.intoAcademiaSinica}</button>
		<div class="hero-bg" aria-hidden="true">
			<Image src={academiaSinica} alt="" class="hero-bg-img" />
		</div>
	</header>

	<main class="activities">
		<div class="activities-container">
			<h1 class="activities-title">{info.activitiesHeading}</h1>
			{
				sections?.map(section => (
					<div class="activities-section">
						<h2 class="section-title">{section.title}</h2>

						{section.activities?.map(activity => {
							return (
								<div class="activity" class:list={{ "activity-reverse": activity.image?.position === "right" }}>
									<Image class="activity-image" src={getActivityImage(activity.image.url)} alt={activity.image.alt ?? activity.title} loading="lazy" />
									<div>
										<h3 class="activity-title">{activity.title}</h3>
										{activity.body
											?.split("\n\n")
											.map(paragraph => paragraph.trim())
											.filter(Boolean)
											.map(paragraph => (
												<p class="activity-paragraph">{paragraph}</p>
											))}
									</div>
								</div>
							);
						})}
					</div>
				))
			}
		</div>
	</main>

	<dialog class="modal" data-transport-dialog>
		<div class="modal-card">
			<div class="modal-header">
				<h2 class="modal-title">交通指引</h2>
				<button class="modal-x" type="button" data-close-transport><X /></button>
			</div>

			<div class="modal-body">
				<div class="modal-button-container" role="tablist" aria-label="交通方式">
					<button class="modal-button is-active" type="button" data-transport-tab="shuttle" role="tab" aria-selected="true">大會接駁車</button>

					<button class="modal-button" type="button" data-transport-tab="public" role="tab" aria-selected="false">大眾運輸工具</button>

					<button class="modal-button" type="button" data-transport-tab="drive" role="tab" aria-selected="false">自行開車 / 機車</button>
				</div>

				<section class="transport-panel" data-transport-panel="shuttle" role="tabpanel">
					<div class="transport-route">
						<div class="transport-route-left">捷運南港展覽館站 2A 出口</div>

						<div class="transport-route-line" aria-hidden="true"></div>

						<div class="transport-route-right">中研院 人文社會科學館</div>
					</div>

					<div class="transport-card">
						<p>地點：台北捷運站南港展覽館 2A 出口（當天會有人舉牌引導）</p>
						<p>接駁車發車時間：7:45~10:00</p>
						<p>班距：15~20 分鐘一班</p>
					</div>
				</section>

				<section class="transport-panel" data-transport-panel="public" role="tabpanel" hidden>
					<div class="transport-card">
						<p>你覺得我會知道大眾運輸要怎麼走嗎</p>
					</div>
				</section>

				<section class="transport-panel" data-transport-panel="drive" role="tabpanel" hidden>
					<div class="transport-card">
						<p>我看起來像是有車的人嗎</p>
					</div>
				</section>
			</div>
		</div>
	</dialog>

	<Footer />
</Layout>

<script>
	window.addEventListener("DOMContentLoaded", () => {
		// Modal logic
		const dialog = document.querySelector<HTMLDialogElement>("[data-transport-dialog]");
		const openButton = document.querySelector<HTMLButtonElement>("[data-open-transport]");
		const closeButton = document.querySelector<HTMLButtonElement>("[data-close-transport]");

		if (!dialog || !openButton || !closeButton) return;

		const tabs = Array.from(document.querySelectorAll<HTMLButtonElement>("[data-transport-tab]"));
		const panels = Array.from(document.querySelectorAll<HTMLElement>("[data-transport-panel]"));

		function activateTab(name: string) {
			tabs.forEach(btn => {
				const active = btn.getAttribute("data-transport-tab") === name;
				btn.classList.toggle("is-active", active);
				btn.setAttribute("aria-selected", active ? "true" : "false");
			});

			panels.forEach(panel => {
				const active = panel.getAttribute("data-transport-panel") === name;
				if (active) panel.removeAttribute("hidden");
				else panel.setAttribute("hidden", "");
			});
		}

		openButton.addEventListener("click", () => {
			if (typeof dialog.showModal === "function") dialog.showModal();
			else dialog.setAttribute("open", "");

			activateTab("shuttle");
		});

		closeButton.addEventListener("click", () => dialog.close());

		dialog.addEventListener("click", (e: MouseEvent) => {
			if (e.target === dialog) dialog.close();
		});

		tabs.forEach(btn => {
			btn.addEventListener("click", () => {
				const name = btn.getAttribute("data-transport-tab");
				if (name) activateTab(name);
			});
		});

		// Into Academia Sinica button logic
		const intoBtn = document.getElementById("into-academia-sinica");
		const hero = document.querySelector<HTMLElement>("header.hero");
		const heroContent = hero?.querySelector<HTMLElement>(".hero-content");
		const main = document.querySelector<HTMLElement>("main.activities");
		const footer = document.querySelector<HTMLElement>("footer");

		let exiting = false;

		intoBtn?.addEventListener("click", () => {
			if (exiting) return;
			exiting = true;

			const html = document.documentElement;
			html.style.scrollBehavior = "auto";

			const se = document.scrollingElement as HTMLElement | null;
			if (se) se.scrollTop = 0;
			document.documentElement.scrollTop = 0;
			document.body.scrollTop = 0;
			window.scrollTo(0, 0);

			const scrollY = window.scrollY;
			document.body.style.position = "fixed";
			document.body.style.top = `-${scrollY}px`;
			document.body.classList.add("page-lock");

			if (hero) {
				const rect = hero.getBoundingClientRect();
				hero.style.height = `${rect.height}px`;
				hero.style.paddingTop = getComputedStyle(hero).paddingTop;
				hero.style.paddingBottom = getComputedStyle(hero).paddingBottom;
			}

			document.body.classList.add("page-lock");
			heroContent?.classList.add("fade-out");
			main?.classList.add("fade-out");
			footer?.classList.add("fade-out");
			intoBtn.classList.add("fade-out");

			hero!.style.height = "100vh";

			const href = "/2026/info/academia-sinica";

			setTimeout(() => {
				window.location.href = href;
			}, 300);
		});
	});
</script>

<style>
	.hero {
		position: relative;
		overflow: hidden;
		display: flex;
		align-items: center;
		justify-content: center;
		padding-block: 13rem;
	}

	.hero-content {
		position: relative;
		display: flex;
		flex-direction: column;
		gap: 2.69rem;
		z-index: 2;

		align-items: center;
		text-align: center;
	}

	.hero-bg {
		position: absolute;
		inset: 0;
		z-index: 0;
		pointer-events: none;
	}

	.hero-bg :global(img.hero-bg-img) {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.hero-title {
		font-size: clamp(3rem, 6vw, 4rem);
		font-weight: bold;
		color: var(--silence-white);
	}

	.hero-details {
		display: flex;
		flex-direction: column;
		color: var(--silence-white);
	}

	.hero-detail {
		font-size: 1.0625rem;
		font-weight: bold;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.hero-button {
		padding: 1rem 2rem;
		font-size: 1.25rem;
		font-weight: bold;
		background-color: var(--coffee);
		color: #ffefcf;
		border-radius: 10rem;
		border: none;
		cursor: pointer;
	}

	.hero-into-button {
		padding: 1rem 2rem;
		font-size: 1rem;
		font-weight: bold;
		background-color: #ffffff4f;
		color: #ffffffcc;
		border-radius: 10rem;
		border: none;
		cursor: pointer;
		position: absolute;
		bottom: 1.63rem;
		right: 2.19rem;
		z-index: 2;
		opacity: 80%;
	}

	.activities {
		background-color: var(--white);
		color: var(--coffee);
		font-family: "GenKiGothicTW", sans-serif;
		padding: 3rem 2rem;
		h2,
		h3 {
			font-family: "GenKiGothicTW", sans-serif;
		}
	}

	.activities-container {
		max-width: 100rem;
		margin-inline: auto;
	}

	.activities-title {
		font-size: 4rem;
		line-height: 1.3;
		padding-left: 1rem;
		font-weight: bold;
		margin-bottom: 1rem;
	}

	.activities-section {
		border-top: 2px solid var(--coffee);
		padding: 3rem 0rem;
		gap: 2rem;
		display: flex;
		flex-direction: column;
	}

	.section-title {
		font-size: 3rem;
		padding-left: 1rem;
		font-weight: bold;
	}

	.activity {
		padding: 0rem 2rem;
		gap: 2.75rem;
		display: flex;
		align-items: center;
	}

	.activity-reverse {
		flex-direction: row-reverse;
	}

	.activity-image {
		width: 18.75rem;
		height: 18.75rem;
		max-width: 100%;
		object-fit: cover;
	}

	.activity-title {
		font-size: 2rem;
		font-weight: bold;
		margin-bottom: 1.125rem;
	}

	.modal {
		display: none;
		border: none;
		padding: 0;
		background: transparent;
		color: var(--silence-white);

		width: 100%;
		max-width: none;
		height: 100%;
		max-height: none;
	}

	.modal[open] {
		display: grid;
		place-items: center;
	}

	.modal::backdrop {
		background: rgba(0, 0, 0, 0.45);
		backdrop-filter: blur(2px);
	}

	.modal-card {
		width: min(50rem, calc(100vw - 2rem));
		padding: 4rem;
		border-radius: 1rem;
		background: rgba(0, 0, 0, 0.44);
		overflow: hidden;
	}

	.modal-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 1.25rem 1.25rem 0.75rem;
	}

	.modal-button {
		background: linear-gradient(90deg, #edb73d 0%, #d1a643 25%, #c39d47 50%, #c09b48 75%, #b6944acc 100%);
		border: 1px solid var(--copper);
		border-radius: 0.75rem;
		cursor: pointer;
		font-size: 1.125rem;
		padding: 0.625rem 1.75rem;
		color: #12121280;
		font-weight: bold;
	}

	.modal-button.is-active {
		filter: brightness(1.05);
		outline: 2px solid rgba(255, 255, 255, 0.35);
		outline-offset: 2px;
	}

	.modal-button-container {
		display: flex;
		gap: 1rem;
		align-items: center; /* horizontal center for column flex */
		justify-content: space-between;
	}

	.modal-title {
		font-size: 2rem;
		font-weight: bold;
		font-family: "GenKiGothicTW", sans-serif;
	}

	.modal-x {
		border: none;
		background: rgb(0, 0, 0);
		color: var(--silence-white);

		width: 2.25rem;
		height: 2.25rem;
		border-radius: 999px;

		display: grid;
		place-items: center;

		cursor: pointer;
		padding: 0;
		line-height: 0;
	}

	.modal-body {
		padding: 1rem 1.25rem 1.25rem;
		display: flex;
		flex-direction: column;
		gap: 1.25rem;
	}

	.transport-panel {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.transport-panel[hidden] {
		display: none !important;
	}

	.transport-route {
		display: flex;
		align-items: center;
		gap: 1.25rem;
		color: var(--silence-white);
		font-weight: 500;
		font-size: 1.25rem;
	}

	.transport-route-left,
	.transport-route-right {
		white-space: nowrap;
	}

	.transport-route-line {
		position: relative;
		flex: 1;
		height: 2px;
		background: var(--silence-white);
		border-radius: 999px;
		min-width: 3rem;
	}

	.transport-route-line::after {
		content: "";
		position: absolute;
		right: 0;
		top: 50%;
		width: 10px;
		height: 10px;
		border-right: 2px solid var(--silence-white);
		border-top: 2px solid var(--silence-white);
		transform: translateY(-50%) rotate(45deg);
	}

	.transport-card {
		border-radius: 0.5rem;
		padding: 1.25rem 1.5rem;
		background: rgba(0, 0, 0, 0.25);
		border: 1px solid rgba(255, 255, 255, 0.3);
	}

	.transport-card p {
		margin: 0;
		font-size: 1rem;
		color: var(--silence-white);
		font-weight: 500;
	}

	@media (max-width: 880px) {
		.hero-button {
			opacity: 80%;
		}

		.hero {
			flex-direction: column;
			gap: 1rem;
			padding-block: 10rem;
		}

		.hero-into-button {
			position: static;
			bottom: auto;
			right: auto;

			margin-top: 0.5rem;
		}

		.activities-title {
			font-size: 3rem;
			padding-left: 0;
		}

		.section-title {
			font-size: 2rem;
			padding-left: 0;
		}
		.activity-title {
			font-size: 1.5rem;
		}

		.activity {
			padding: 0;
			gap: 2rem;
			flex-direction: column;
			align-items: stretch;
		}

		.activity-reverse {
			flex-direction: column;
		}

		.activity-image {
			width: 100%;
			height: auto;
			max-height: 20rem;
			aspect-ratio: 35 / 20;
			object-fit: cover;
			border-radius: 0.75rem;
		}

		.activities-section {
			padding: 1.5rem 0rem;
		}
	}

	/* For modal */
	@media (max-width: 730px) {
		.modal-card {
			padding: 0.5rem;
		}
		.transport-route-left,
		.transport-route-right {
			white-space: normal;
		}
		.modal-button-container {
			flex-direction: column;
			gap: 0.75rem;
		}

		.modal-button {
			width: 100%;
		}
	}

	.page-lock {
		overflow: hidden;
	}

	.hero {
		transition:
			height 700ms ease,
			padding-top 700ms ease,
			padding-bottom 700ms ease;
		will-change: height, padding-top, padding-bottom;
	}

	.fade-out {
		opacity: 0;
		transform: translateY(10px);
		transition:
			opacity 700ms ease,
			transform 700ms ease;
		pointer-events: none;
	}

	.hero-content,
	.activities,
	footer,
	.hero-into-button {
		transition:
			opacity 700ms ease,
			transform 700ms ease;
	}

	.hero-bg :global(img.hero-bg-img) {
		transition: transform 900ms ease;
		will-change: transform;
	}

	.hero.hero-fullscreen .hero-bg :global(img.hero-bg-img) {
		transform: scale(1.06);
	}
</style>
